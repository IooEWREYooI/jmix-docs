= Работа в изолированной сети

В этом разделе рассказывается, как установить локальный репозиторий, чтобы использовать его для хранения всех необходимых артефактов - версий Jmix, аддонов и дополнительных библиотек - вместо публичного репозитория Jmix. Это рекомендуется делать в следующих случаях:

* У вас нестабильное или слабое интернет-соединение. Несмотря на то, что Gradle кэширует артефакты на компьютере разработчика, время от времени все-таки необходимо подключаться к репозиторию артефактов, например, при первом запуске проекта или при переключении на новую версию фреймворка.
* У вас ограничен доступ к интернету из-за политики безопасности организации.
//Это нужно?
////
* Вы не собираетесь продлевать подписку на премиум-дополнения, но вы бы хотели продолжить разработку вашего приложения в будущем, используя загруженные версии артефактов.
////

[[install-nexus]]
== Установка локального Nexus

Рассмотрим пример установки менеджера репозиториев Sonatype Nexus OSS.

* Скачайте на компьютер Sonatype Nexus OSS версии 3.x по ссылке https://help.sonatype.com/repomanager3/product-information/download/download-archives---repository-manager-3[^].
* Распакуйте архив.
* Перейдите в подкаталог `bin` и запустите менеджер репозиториев командой `run`:
+
.On Windows
[source,bash]
----
nexus.exe /run
----
+
.On Linux
[source,bash]
----
./nexus run
----
* Откройте в браузере адрес `++http://localhost:8081++`.
* После первого запуска смените пароль по умолчанию:
+
image::ROOT:nexus-login.png[align="center"]

[[create-jmix-repository]]
== Создание репозитория Jmix

Далее сконфигурируем репозиторий, который будет использоваться для установки артефактов.

* Перейдите в меню администратора и далее нажмите на кнопку *Repositories*.
+
image::ROOT:nexus-repository.png[align="center"]
* Нажмите на кнопку *Create repository*.
* Выберите тип `maven2 hosted`.
* Заполните поле *Name* и нажмите на кнопку *Create repository*:
+
image::ROOT:nexus-repository-create.png[align="center"]

[[install-deptool]]
== Установка Jmix Dependencies Tool

https://github.com/jmix-framework/jmix-dependencies-tool[Jmix Dependencies Tool] (`deptool`) - это утилита командной строки, позволяющая подготовить пользовательский Nexus репозиторий для разработки проектов на основе Jmix в изолированной среде (без доступа в Интернет).

* Скачайте последний доступный релиз `deptool` по ссылке https://github.com/jmix-framework/jmix-dependencies-tool/releases[^].
* Распакуйте архив. Для выполнения CLI команд используйте `bin/deptool` или `bin/deptool.bat` файл.
+
NOTE: Для запуска утилиты вам потребуется xref:setup.adoc#jdk[установка Java 11+].

[[download-artefacts]]
== Загрузка архива артефактов

`deptool` может вычислить необходимые версии всех зависимостей, необходимых для Jmix и скачать их локально на ваш компьютер. Для этого используются команды `resolve-jmix`, `resolve-lib` (см. https://github.com/jmix-framework/jmix-dependencies-tool[руководство]). Но обычно нет необходимости вызывать эти команды самостоятельно. На сайте Jmix вы можете найти заранее подготовленные архивы с артефактами для всех версий Jmix.

Скачайте ZIP-архив c необходимой версией Jmix с сайта https://www.jmix.ru/resources/jmix-dependencies[^]. Архив содержит все бесплатные Jmix-аддоны и прочие зависимости, необходимые для работы с проектом Jmix. Распакуйте архив.

[[import-artefacts]]
== Импорт артефактов

Импорт артефактов осуществляется командой `upload`:

[source,bash]
----
./deptool upload --nexus-url http://localhost:8081 \ //<1>
--nexus-repository jmix \ //<2>
--nexus-username admin \ //<3>
--nexus-password adminpass \ //<4>
--artifacts-dir ../export //<5>
----
<1> Адрес пользовательского репозитория Nexus.
<2> Название репозитория.
<3> Логин для входа в менеджер репозиториев Nexus.
<4> Пароль для входа в менеджер репозиториев Nexus.
<5> Каталог с артефактами, которые будут загружены в Nexus. Это каталог, в который вы распаковали архив, скачанный на <<download-artefacts,предыдущем шаге>>.

В результате выполнения данной операции репозиторий `jmix` локального Nexus будет заполнен необходимыми артефактами.

//Этот подраздел сможем написать потом, когда Макс продумает реализацию
//[[download-premium-addon]]
//=== Загрузка премиум аддонов

//<<download-artefacts,Aрхив>> на сайте не содержит премиум аддонов. Для их установки в Nexus репозиторий необходимо выполнить ряд дополнительных операций.

//* Введите лицензионный ключ через команду в оболочке CUBA SDK:
//+
//[source,bash]
//----
//cuba-sdk set-license
//----

//* Далее установите дополнение в локальный репозиторий. Рассмотрим на примере установки дополнения xref:maps:index.adoc[Maps]:
//+
//[source,bash]
//----
//cuba-sdk install jmix-addon
//----
//+
//image::ROOT:cuba-sdk-install-addon.png[align="center"]

//Команда `install jmix-addon` вычисляет все необходимые зависимости для конкретного аддона, скачивает их в рабочую папку утилиты CUBA SDK и затем загружает их в target Nexus репозиторий (в нашем примере это репозиторий с именем `jmix`).

[[deptool-functionality]]
== Другие возможности deptool

Утилита `deptool` предоставляет следующие дополнительные возможности:

* Разрешает и загружает зависимости, необходимые для запуска Jmix, в кэш Gradle.
* Разрешает и загружает артефакты, используемые любой отдельной зависимостью.
* Экспортирует разрешенные зависимости в формате репозитория Maven.

Подробнее об использовании этих возможностей можно посмотреть в инструкции, доступной по https://github.com/jmix-framework/jmix-dependencies-tool[ссылке].

// Это нужно только в случае если пользователь будет сам собирать зависимости. В случае простого upload это не нужно
//[[install-gradle]]
//== Установка Gradle

//* Скачайте Gradle версии 7.x с сайта https://gradle.org/releases/[^].
//* Распакуйте в рабочий каталог, например, `C:\tools`.
//* Добавьте подкаталог `bin` установленного Gradle в переменную `PATH` операционной системы.

[[create-jmix-project]]
== Создание проекта Jmix

* Запустите IntelliJ IDEA с установленным xref:setup.adoc#studio[плагином Jmix].
* Создайте xref:studio:project.adoc#creating-new-project[новый] Jmix проект с пользовательской конфигурацией репозиториев, в которой укажите путь и параметры подключения к локальному репозиторию:
+
image::ROOT:new-project-custom-conf.png[align="center",width="868"]
+
Список доступных версий Jmix определяется версиями имеющихся в репозитории артефактов `io.jmix.templates.studio:jmix-studio-templates`.
* После открытия проекта добавьте следующие строки в начало файла `settings.gradle`:
+
[source,groovy]
----
pluginManagement {
    resolutionStrategy {
        eachPlugin {
            if (requested.id.id == 'io.jmix') {
                useModule("io.jmix.gradle:jmix-gradle-plugin:${requested.version}")
            }
        }
    }

    repositories {
        maven {
            allowInsecureProtocol true //<1>
            url 'http://localhost:8081/repository/jmix/' //<2>
            credentials {
                username(rootProject.hasProperty('repoUser') ? rootProject['repoUser'] : 'admin')
                password(rootProject.hasProperty('repoPass') ? rootProject['repoPass'] : 'adminpass')
            }
        }
    }
}
----
<1> Инструкция `allowInsecureProtocol true` требуется, если ваш репозиторий Nexus использует протокол HTTP.
<2> URL пользовательского репозитория Nexus.

* Отредактируйте `build.gradle` следующим образом:
** Добавьте инструкцию `allowInsecureProtocol true` в секцию `maven`.
** Удалите инструкцию `mavenCentral()` из секции `maven`.
+
[source,groovy]
----
//
repositories {
    maven {
        allowInsecureProtocol true
        url 'http://localhost:8081/repository/jmix'
        credentials {
            username(rootProject.hasProperty('repoUser') ? rootProject['repoUser'] : 'admin')
            password(rootProject.hasProperty('repoPass') ? rootProject['repoPass'] : 'adminpass')
        }
    }
}
//
----

* В панели *Gradle* нажмите *Reload All Gradle Projects*, чтобы обновить конфигурацию проекта.