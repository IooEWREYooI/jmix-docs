= 创建 GWT 组件

[[creating-custom-widgetset]]
== 创建自定义小部件集

Jmix 框架在 `jmix-ui-widgets-compiled` 制件中提供一组编译好的小部件集。

如需在项目中创建自定义的小部件集，请按照下列步骤：

. 删除 `implementation 'io.jmix.ui:jmix-ui-widgets-compiled'` 依赖。
. 在 `build.gradle` 添加下列依赖：
+
[source,gradle,indent=0]
----
include::example$/ex1/build.gradle[tags=widgets-dependency]
----
<1> 仅开发自定义客户端组件需要。
+

[[compile-widgets]]
. 添加 `compileWidgets` 任务（根据你的应用程序包路径修改）：
+
[source,gradle,indent=0]
----
include::example$/ex1/build.gradle[tags=compile-widgets]
----
+
[NOTE]
====
如果某些界面修改了，但是不希望重新编译小部件集，则可以使用 `compileWidgets` 任务的 `excludePaths` 和 `includePaths` 参数。

`excludePaths` 参数用于在编译小部件集的过程中排除某些路径或文件。示例：

[source,gradle,indent=0]
----
compileWidgets {
    generate 'com.company.demo.widgets.CustomWidgetSet'
    excludePaths('**/com/company/demo/**')
}
----

这样，`com.company.demo` 包内的改动不会触发小部件集的编译。

`includePaths` 参数用于在编译小部件集的过程中包含某些路径或文件。示例：

[source,gradle,indent=0]
----
compileWidgets {
    generate 'com.company.demo.widgets.CustomWidgetSet'
    includePaths('**/io/jmix/**/widget/**', '**/com/company/demo/widgets/**')
}
----

这样，`com.company.demo.widgets` 包内的改动和任何 `io.jmix` 包下 `widget` 包（包括子包）内的改动都会触发小部件集的编译。其他地方的改动，例如，界面控制器或者 XML 描述的改动不会触发编译。如果遇到意料之外的重编译，使用 `--info` 参数执行 `compileWidgets` 可以查看特定原因。

`excludePaths` 和 `includePaths` 参数都支持字符串格式的列表。

格式可以包含：

* `*` 匹配任意长度的字符。
* `?` 匹配单一字符。
* `**` 匹配任意目录或文件。

格式中可以使用 `'/'` 或 `'\'` 作为文件目录分隔符。

例如，`+includePaths('**/com/company/demo/widgets/**')+` 包含 `com/company/demo/widgets` 文件夹及其子文件夹内的所有文件。

更多信息请参考 https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/util/PatternFilterable.html[^]。
====
. 在 `application.properties` 文件添加 `jmix.ui.widget-set` 属性（根据上面 `compileWidgets` 任务修改路径）：
+
[source,properties,indent=0]
----
include::example$/ex1/src/main/resources/application.properties[tags=widget-set]
----

小部件集通过名为 `compileWidgets` 的 `WidgetsCompile` 类型任务编译。使用 Jmix 插件会自动创建。

编译完成的小部件集位于 `build/widgets` 目录，并包含在项目的 JAR/WAR 制件中。

[[color-button-gwt-component]]
== 创建 ColorButton GWT 组件

在本节中，我们将创建一个自定义的 `ColorButton` 组件。该组件直接继承 `JmixButton` 组件。

自定义 UI 组件（即直接继承自 Vaadin 组件的组件）应放在 `widgets` 子包中，例如，`com.company.sample.widgets`。客户端组件（连接器和小部件），以及用于服务器端和客户端通信的类，例如 RPC 和状态类，应该放在 `widgets.client` 子包中，例如 `com.company.sample.widgets.client`。有关“客户端-服务器”集成的更多信息，请参阅 Vaadin https://vaadin.com/docs/v8/framework/gwt[文档^]。

[[component-state-class]]
=== 创建组件状态类

在 `widgets.client` 包中创建 `ColorButtonState.java`。

`ColorButtonState` 状态类定义了客户端和服务器之间发送的数据。其中包含 public 字段，用于在服务器端自动序列化并在客户端反序列化。

.ColorButtonState.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/widgets/client/ColorButtonState.java[tags=color-button-state]
----

[[vaadin-component-class]]
=== 创建 Vaadin 组件类

`ColorButton` 是一个 Vaadin 组件类，可以为服务端代码、访问器方法、事件监听器和数据源连接定义 API。开发人员在应用程序代码中使用此类的方法。

在 `widgets` 包中创建 `ColorButton.java`：

.ColorButton.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/widgets/ColorButton.java[tags=color-button]
----

[[connector]]
=== 创建连接器

在 `widgets.client` 包中创建 `ColorButtonConnector.java`。

`ColorButtonConnector` 连接器将客户端代码与服务器链接。

.ColorButtonConnector.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/widgets/client/ColorButtonConnector.java[tags=color-button-connector]
----
<1> 使用此注解标记 `ColorButtonConnector` 连接器为具有服务器端对应实现。注解的值是 `ColorButton` - 服务器端实现的类。
<2> 返回此连接器的 `ColorButtonState` 对象。
<3> 对服务器状态变化做出响应。
<4> 如果服务器上的值已更改，则刷新小部件的样式。

[[using-color-button]]
=== 使用 ColorButton

为了演示组件的工作原理，让我们创建一个新的 `color-button-screen` 界面。

打开 `ColorButtonScreen.java` 界面控制器并添加代码将组件放置于界面：

.ColorButtonScreen.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/colorbutton/ColorButtonScreen.java[tags=color-button-screen]
----
<1> 初始化一个 `ColorButton` 组件实例。
<2> 使用 `unwrap()` 方法获取 Vaadin 容器的连接，并将新组件添加到其中。

下图为项目结构：

image::custom-components/project-structure.png[align="center"]

启动应用程序并查看结果：

image::custom-components/color-button.png[align="center"]
