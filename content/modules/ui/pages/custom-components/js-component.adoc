= 通用 JavaScript 组件
:page-aliases: backoffice-ui:custom-components/js-component.adoc

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://demo.jmix.io/sampler/#main/sample?id=java-script-component-time-picker" class="live-demo-btn" target="_blank">在线示例</a>
</div>
++++

`JavaScriptComponent` 是个简单的 UI 组件，通过它可以使用 JavaScript 组件，不需要通过 Vaadin 实现。因此，通过这个组件可以很容易地在基于 Jmix 的项目中集成任何纯 JavaScript 组件。

该组件可以在界面的 XML 描述中以声明的方式定义，因此可以在 XML 中配置动态属性和 JavaScript 依赖。

组件的 XML 名称：`jsComponent`。

== 定义依赖

可以为该组件定义一个依赖列表（JavaScript、CSS）。依赖从下列源获取：

* WebJar 资源 - 以 `webjar://` 开头。
* `VAADIN` 目录下的文件 - 以 `vaadin://` 开头。
* Web 资源 - 以 `http://` 或 `https://` 开头。

[[element-dependencies]]
依赖列表定义在 `dependencies` 元素中。每个依赖通过内部的 `dependency` 元素进行描述。

[[dependency-path]]
`path` 属性用于定义依赖的路径。

在 XML 中定义依赖的示例：

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/components/javascript/java-script-component-sample.xml[tags=js-component]
----

[[dependency-type]]
如果依赖的类型不能从扩展中得知，需要在 XML 的 `type` 属性中指定类型。或者传递 `DependencyType` 枚举值给 `addDependency()` 方法。

[TIP]
====
如需在 Jmix Studio 中添加依赖，可以在界面 XML 或者 *Component Hierarchy* 面板中选择 `jsComponent`，然后点击 *Component Inspector* 面板的 xref:studio:screen-designer.adoc#component-inspector-add-button[Add]*->Dependency* 按钮。
====

你也可以使用 `addDependency()` 方法编程式添加依赖。方法接收 `DependencyType` 枚举值指定依赖的类型。

以编程方式添加依赖的示例：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/JavaScriptComponentSample.java[tags=add-dependencies]
----

[[init-function-name]]
== 定义初始化函数

该组件需要一个初始化函数。框架用此函数的名称用来查找 JavaScript 组件连接器（connector）的入口。

[CAUTION]
====
初始化函数的名称在一个浏览器窗口内必须唯一。
====

`jsComponent` 的 `initFunctionName` 属性可用于指定该函数名称。

函数名称也可以通过 `setInitFunctionName()` 方法传递给组件：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/JavaScriptComponentSample.java[tags=set-init-function-name]
----

== 定义 JavaScript 连接器

如需使用 `JavaScriptComponent` 包装 JavaScript 库，需要定义 JavaScript 连接器，其功能主要是初始化 JavaScript 组件并且处理服务端和 JavaScript 代码之间的通信。

连接器函数中可以使用下列方法：

* `this.getElement()` 返回组件的 HTML DOM 元素。
* `this.getState()` 返回当前状态的共享状态对象，此状态与服务端同步。

== 组件功能

`JavaScriptComponent` 有下列功能：

* 设置一个状态对象，该对象可以在客户端层的 JavaScript 连接器中使用，并且可以通过组件状态的 `data` 字段访问，示例：
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/JavaScriptComponentSample.java[tags=state]
----
* 注册一个函数，该函数可以在 JavaScript 中使用提供的名称进行调用，示例：
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/JavaScriptComponentSample.java[tags=register-function]
----
* 调用命名的函数，该函数由连接器的 JavaScript 代码添加到包装的对象中。
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/JavaScriptComponentSample.java[tags=call-function]
----
+
[source,js,indent=0]
----
include::example$/ex1/src/main/resources/VAADIN/timepicker/time-picker-connector.js[tags=function]
----

== 示例

本节介绍如何在基于 Jmix 的应用中集成第三方 JavaScript 库，使用 https://quilljs.com/[Quill 富文本编辑器^] 作为示例。请按照下面的步骤集成。

////
This section describes integrating a third-party JavaScript library to a Jmix-based application taking http://ericjgagnon.github.io/wickedpicker/[Wickedpicker^] - a simple jQuery timepicker plugin. To use Wickedpicker in your project, you should follow the steps below.
////

. 在 `build.gradle` 文件添加以下依赖：
+
[source,gradle,indent=0]
----
include::example$/ex1/build.gradle[tags=quill]
----

. 在 `src/main/resources/VAADIN/quill` 目录内创建 `quill-connector.js` 文件。
. 在此文件内，添加连接器的实现：
+
[source,js,indent=0]
----
include::example$/ex1/src/main/resources/VAADIN/quill/quill-connector.js[]
----
<1> 处理服务端的状态变更。
<2> 订阅 `textChange` 事件。

. 创建一个界面，包含以下 `jsComponent` 定义：
+
[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/components/javascript/rich-text-editor-screen.xml[]
----

. 添加下面的界面控制器实现：
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/components/javascript/RichTextEditorScreen.java[tags=rich-text-editor-screen]
----

执行结果，界面中可以看到 Quill 富文本编辑器：

image::custom-components/java-script-component.png[align="center"]

[[xml]]
== XML 属性

include::../vcl/xml-studio-tip.adoc[]

xref:vcl/xml.adoc#align[align] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
xref:vcl/xml.adoc#enable[enable] -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<init-function-name,initFunctionName>> -
xref:vcl/xml.adoc#required-indicator-visible[requiredIndicatorVisible] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]

[[xml-js-component-elements]]
=== JavaScriptComponent XML 元素

<<element-dependencies,dependencies>>

[[xml-dependency-attributes]]
=== Dependency XML 属性

<<dependency-path,path>> -
<<dependency-type,type>>
