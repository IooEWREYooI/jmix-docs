= Собственные типы действий

В проекте можно создать собственные типы действий или переопределить существующие стандартные типы.

Предположим, что вы хотите создать действие, которое бы показывало имя экземпляра текущей сущности, выбранной в таблице, и использовать это действие в различных экранах, указывая только его тип. Чтобы это сделать, необходимо выполнить следующие шаги:

. Создайте для действия отдельный класс с аннотацией `@ActionType`, в которой укажите желаемое имя типа:
+
[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/actions/ShowSelectedAction.java[tags=showSelected-start;showSelected-end]
----

. Теперь вы можете использовать действие в дескрипторах экрана, просто указывая его тип:
+
[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/actions/action-screen.xml[tags=custTable-start;actions-start;show-action;actions-end;columns;buttonsPanel-start;buttonsPanel-show;buttonsPanel-end;custTable-end]
----

[NOTE]
====
Если вы хотите переопределить существующий тип действия, просто зарегистрируйте свое новое действие с таким же типом.
====

== Использование собственных действий в Studio

Собственные типы действий, реализованные в вашем проекте, могут быть встроены в интерфейс дизайнера экранов Jmix Studio. Дизайнер экранов предоставляет следующую поддержку для собственных типов действий:

* Возможность выбрать тип действия в списке стандартных действий во время добавления нового действия в экран из палитры или при выполнении *+Add → Action* в таблице.
* Быстрая навигация из места использования действия к классу действия по нажатию *Ctrl + B* или Ctrl-клику мыши, когда курсор находится на типе действия в дескрипторе экрана (например на атрибуте `showSelected` в XML-фрагменте `<action id="show" type="showSelected">`).
* Редактирование определенных пользователем свойств действия в панели *Component Inspector*.
* Генерация обработчиков событий и делегирующих методов, объявленных в классе действия для кастомизации его логики.
* Поддержка параметризации генерик-типом. Генерик-тип определяется как класс сущности, используемый в таблице (компонент-владелец действия).

Аннотация `@io.jmix.ui.meta.StudioAction` используется для пометки собственного класса действия, содержащего дополнительные свойства, определенные пользователем. Собственные действия нужно помечать этой аннотацией, однако в данный момент Studio не использует дополнительных атрибутов аннотации `@StudioAction`.

Аннотация `@io.jmix.ui.meta.StudioPropertiesItem` используется, чтобы пометить setter-метод свойства действия как редактируемое свойство. Такие свойства будут отображаться и редактироваться в панели *Component Inspector* дизайнера экранов. Аннотация имеет следующие атрибуты:

* `name` - название атрибута, который будет сохраняться в XML. Если не установлено, то название будет определено по именованию setter-метода.
* `type` - тип свойства. Используется панелью *Component Inspector*, чтобы создать подходящий компонент ввода, предоставляющий подсказки и базовую валидацию.
//TODO: Описания всех типов свойств приведены здесь.
* `caption` - подпись свойства, отображается в панели *Component Inspector*.
* `description` - дополнительное описание свойства, отображается в панели *Component Inspector* как всплывающая подсказка по наведению мыши.
* `category` - категория свойства в панели *Component Inspector* (на данный момент еще не используется дизайнером экранов).
* `required` - обязательность свойства. Если свойство обязательное, то панель *Component Inspector* не позволит ввести для него пустое значение.
* `defaultValue` - значение свойства по умолчанию, т.е. значение, которое неявно используется действием, если соответствующий XML-атрибут отсутствует. Значение по умолчанию не будет записываться в XML.
* `options` - список вариантов для свойства действия, например для типа свойства `ENUMERATION`.

Заметьте, что для свойств действий поддерживается только ограниченный набор Java типов:

* Примитивные типы `String`, `Boolean`, `Byte`, `Short`, `Integer`, `Long`, `Float`, `Double`.
* Перечисления.
* `java.lang.Class`.
* `java.util.List` – список, состоящий из элементов, чьи типы указаны выше. Панель *Component Inspector* не имеет точно подходящего компонента для этого Java класса, поэтому этот тип должен вводиться как обычная строка, и помечаться как `PropertyType.STRING`.

Примеры:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/actions/ShowSelectedAction.java[tags=studio-properties]
----
<1> Строковое свойство с ограниченным набором вариантов ввода и значением по умолчанию.
<2> Обязательное свойство с набором вариантов - списком классов экранов, определенных в проекте.
<3> Список целых чисел. Тип свойства установлен как `STRING`, т.к. панель *Component Inspector* не содержит подходящего компонента ввода.

Также Studio предоставляет поддержку для событий и делегирующих методов в собственных действиях – такую же, как и для встроенных UI компонентов. Для объявления слушателя события или делегирующего метода в классе действия не требуется никаких дополнительных аннотаций. Пример их объявления приведен ниже.

== Пример: SendByEmailAction

Этот пример демонстрирует:

* объявление и аннотирование класса собственного действия.
* аннотирование редактируемых параметров действия.
* объявление собственного класса события, производимого действием, и его обработчика.
* объявление делегирующих методов.

Действие `SendByEmailAction` реализует посылку email о сущности, выбранной в таблице, которой принадлежит действие. Это действие реализовано как полностью конфигурируемое, большая часть его внутренней логики может быть изменена с помощью редактируемых свойств, делегирующих методов и событий.

Исходный код действия:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/actions/SendByEmailAction.java[tags=send-by-email-action]
----
<1> Класс действия помечен аннотацией `@StudioAction`.
<2> `id` действия устанавливается аннотацией `@ActionType`.
<3> Класс действия параметризован типом `E` – это тип сущности, которая отображается компонентом таблицы.
<4> Адрес получателя email выставлен как редактируемое свойство действия.
<5> Метод, регистрирующий слушатель для события `EmailSentEvent`. Этот метод определяется Studio как объявление обработчика события в действии.
<6> Метод, устанавливающий объект `Function`. Этот объект используется для делегирования (контроллеру экрана) логики составления текста письма. Этот метод определяется Studio как объявление делегирующего метода.
<7> Объявление другого делегирующего метода – на этот раз он используется для делегирования логики создания вложений к письму. Заметьте, что оба делегирующих метода используют параметр `E` генерик-типа.
<8> Обязательный делегирующий метод (реализованный в контроллере экрана) вызывается для составления текста письма.
<9> Если установлен, необязательный делегирующий метод вызывается для генерации вложений к письму.
<10> Здесь, собственно, и посылается email.
<11> Событие `EmailSentEvent` публикуется после успешной посылки письма. Если контроллер экрана был подписан на это событие, то будет вызван соответствующий обработчик.
<12> Объявление класса события. Обратите внимание, что в класс события можно добавить поля и таким образом передавать в логику обработки события дополнительные данные.

Если реализовать класс как показано выше, то Studio отобразит новое собственное действие вместе со стандартными действиями в диалоге создания действия:

image::actions/studio-custom-action.png[align="center"]

Когда действие добавлено в дескриптор экрана, вы можете выбрать его и редактировать его свойства в панели *Component Inspector*:

image::actions/studio-custom-action-properties.png[align="center"]

Когда свойство собственного действия изменяется в панели *Component Inspector*, оно записывается в дескриптор экрана следующим образом:

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/table/table-screen.xml[tags=sendByEmail-action]
----

Обработчики событий и делегирующие методы действия также отображаются и доступны для генерации в панели *Component Inspector*:

image::actions/studio-custom-action-handlers.png[align="center"]

Пример сгенерированной логики с реализованными обработчиками события и делегирующими методами выглядит следующим образом:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/table/TableScreen.java[tags=table-screen-start;inject-notifications;inject-SendByEmailAction;sendByEmailAction-handlers;table-screen-end]
----
<1> При инжекции действия используется корректный параметр типа.
<2> Реализация обработчика события.
<3> Реализация делегирующего метода `bodyGenerator`. Параметр типа `Customer` подставлен в сигнатуру метода.
<4> Реализация делегирующего метода `attachmentProvider`.

