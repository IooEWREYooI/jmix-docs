= FileStorageUploadField
:page-aliases: backoffice-ui:vcl/components/file-storage-upload-field.adoc

`FileStorageUploadField - 文件存储上传控件` 支持将文件上传至 xref:files:index.adoc[文件存储] 并作为 `FileRef` 对象连接至实体属性。

这个控件包含标题、已上传文件的链接和一个上传按钮。当点击上传按钮的时候，会弹出系统标准的文件选择器，用户可以在这里选择需要上传的文件。

image::vcl/components/file-storage-upload-field.gif[align="center"]

组件的 XML 名称：`fileStorageUpload`。

[[basics]]
== 基本用法

下面例子中，`Person` 实体的 `image` 属性是 `FileRef` 类型。

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/entity/Person.java[tags=file-storage-upload-field]
----

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=data;file-storage-upload]
----

如需将文件在实体属性中以字节数组的格式存储而非 `FileRef`，请使用 xref:vcl/components/file-upload-field.adoc[FileUploadField] 组件。

上传的文件会立即存至 xref:files:index.adoc[文件存储]。如需以编程的方式控制文件的存储，可以使用 <<file-storage-put-mode,fileStoragePutMode>> 属性。

[[listeners]]
== 监听器

下列监听器可用于跟踪文件上传过程：

[[after-value-clear-listener]]
* `AfterValueClearListener` - 内容被使用清除按钮清除后调用。

[[before-value-clear-listener]]
* `BeforeValueClearListener` - 点击清除按钮时调用。

[[file-upload-error-listener]]
* `FileUploadErrorListener` -  上传结束，但不成功时调用。

[[file-upload-finish-listener]]
* `FileUploadFinishListener` - 文件上传之后调用。

[[file-upload-start-listener]]
* `FileUploadStartListener` - 开始上传时调用。

[[file-upload-succeed-listener]]
* `FileUploadSucceedListener` - 文件成功上传后调用。

[[value-change-listener]]
* `ValueChangeListener` - 值改变时调用。

[[attributes]]
== 属性

[[file-storage-put-mode]]
=== fileStoragePutMode

`fileStoragePutMode` 属性默认设置为 `IMMEDIATE`。如果设置为 `MANUAL` 值，则能以编程的方式控制文件的保存：

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=manually-controlled]
----

界面控制器中，注入组件和 `TemporaryStorage` 接口。然后订阅文件上传成功或出错的 <<listeners,事件>>：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filestorageuploadfield/FileStorageUploadFieldScreen.java[tags=manually]
----

<1> 如果需要，可以获取上传至临时存储的文件。
<2> 按需处理文件。
<3>	保存文件至 FileStorage。


该组件将文件上传至临时存储之后，便会调用 `FileUploadSucceedEvent` 的监听器。

`TemporaryStorage.putFileIntoStorage()` 方法将上传的文件从临时客户端存储移至 xref:files:index.adoc[文件存储]。方法参数为文件 id 和文件名。两个参数都由 `FileStorageUploadField` 提供。

[[file-storage]]
=== fileStorage

`fileStorage` 属性可以指定一个 `FileStorage` 的名称，上传后的文件存在这里。

[[drop-zone]]
=== dropZone

//todo add link to box layout
`dropZone` 属性可以指定一个 xref:vcl/containers/box-layout.adoc[BoxLayout] 作为从浏览器外部拖拽文件可以放置的目标容器区域。这个目标区域可以覆盖整个对话框的窗口。当文件被拖拽到这块区域的时候，这个容器会被高亮显示，否则目标区域不会显示。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=dynamic-drop-zone]
----

image::vcl/components/dynamic-file-storage-upload-field.png[align="center"]

如果想要 dropZone 不变并且一直显示，需要给这个容器设置预定义的样式名称 `dropzone-container`。此时这个容器应该是空的，只包含一个 `label` 组件：

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=static-drop-zone]
----

[[drop-zone-prompt]]
=== dropZonePrompt

`dropZonePrompt` 属性展示拖拽文件于窗口之上时显示的提示信息。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=drop-zone-prompt]
----

[[paste-zone]]
=== pasteZone

`pasteZone` 属性设置一个布局容器用来处理粘贴（paste）的快捷键。此时需要这个容器内部的一个文字输入控件获得焦点（focused）。`pastZone` 属性设置为布局容器的 id。这个功能只支持基于 Chromium 的浏览器。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=paste-zone]
----

[[file-size-limit]]
=== fileSizeLimit

最大可上传的文件大小是由 xref:app-properties.adoc#jmix-ui-component-upload-field-max-upload-size-mb[jmix.ui.component.uploadFieldMaxUploadSizeMb] 应用程序属性定义的，默认是 20MB。如果用户选择了更大的文件的话，会有相应的提示信息，并且中断上传过程。如需修改特定 `fileStorageUploadField` 支持的最大文件大小，可以用 `fileSizeLimit` 属性，以字节为单位。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=file-size]
----

[[permitted-extensions]]
=== permittedExtensions

`permittedExtensions` 设置允许的文件扩展名白名单。这个属性的值需要是字符串的集合，其中每个字符串是以 `.` 开头的允许的文件扩展名。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=permitted-extensions]
----

[[accept]]
=== accept

`accept` 属性设置文件选择对话框里面的文件类型掩码，但是用户还是可以选择“所有文件”来上传任意文件。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=accept]
----

[[show-file-name]]
=== showFileName

`showFileName` 属性控制上传文件的名称是否要显示在上传按钮旁边，默认是 `false` 不显示。

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=file-name]
----

[[upload-button-attributes]]
=== uploadButton 属性

下列属性可以配置上传按钮：

[[upload-button-caption]]
* `uploadButtonCaption`

[[upload-button-icon]]
* `uploadButtonIcon`

[[upload-button-description]]
* `uploadButtonDescription`

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=upload-attributes]
----

[[clear-button-attributes]]
=== clearButton 属性

下列属性可以配置清除按钮：

[[show-clear-button]]
* `showClearButton`

[[clear-button-caption]]
* `clearButtonCaption`

[[clear-button-icon]]
* `clearButtonIcon`

[[clear-button-description]]
* `clearButtonDescription`

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=clear-attributes]
----

[[methods]]
== 方法

* `getFileId()` - 返回上传至 `TemporaryStorage` 中文件的 `id`。
* `getFileName()` - 返回显示在上传按钮旁边文件下载链接的标题。

[[xml]]
== FileStorageUploadField XML 属性

<<accept, accept>> -
xref:vcl/xml.adoc#align[align] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
xref:vcl/xml.adoc#buffered[buffered] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
<<clear-button-caption,clearButtonCaption>> -
<<clear-button-description,clearButtonDescription>> -
<<clear-button-icon,clearButtonIcon>> -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/xml.adoc#data-container[dataContainer] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
<<drop-zone, dropZone>> -
<<drop-zone-prompt,dropZonePrompt>>
xref:vcl/xml.adoc#editable[editable] -
xref:vcl/xml.adoc#enable[enable] -
<<file-size-limit,fileSizeLimit>> -
<<file-storage-put-mode,fileStoragePutMode>> -
<<file-storage,filestorage>> -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<paste-zone, pasteZone>> -
<<permitted-extensions, permittedExtensions>> -
xref:vcl/xml.adoc#property[property] -
xref:vcl/xml.adoc#required[required] -
xref:vcl/xml.adoc#required-message[requiredMessage] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
<<show-clear-button, showClearButton>> -
<<show-file-name, showFileName>> -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#tab-index[tabindex] -
<<upload-button-caption, uploadButtonCaption>> -
<<upload-button-description, uploadButtonDescription>> -
<<upload-button-icon, uploadButtonIcon>>
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]
