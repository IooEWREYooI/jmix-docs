= FileStorageUploadField

Компонент `FileStorageUploadField` позволяет загружать файл в xref:files:index.adoc[файловое хранилище] и связать его с атрибутом сущности как объект `FileRef`.

Компонент может содержать заголовок, ссылку на загруженный файл и кнопку загрузки. При нажатии на кнопку отображается стандартное для операционной системы окно, в котором можно выбрать файл.

image::vcl/components/file-storage-upload-field.gif[align="center"]

XML-имя компонента: `fileStorageUpload`.

[[basics]]
== Основы

В приведенном ниже примере атрибут `image` сущности `Person` имеет тип `FileRef`.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/entity/Person.java[tags=file-storage-upload-field]
----

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=data;file-storage-upload]
----

Чтобы сохранить файл в атрибуте сущности в виде байтового массива вместо `FileRef`, используйте компонент xref:vcl/components/file-upload-field.adoc[FileUploadField].

//todo add link to FileStorage
Загруженный файл будет немедленно сохранен в файловом хранилище по умолчанию. Чтобы управлять сохранением файла программно, используйте атрибут <<file-storage-put-mode,fileStoragePutMode>>.

[[listeners]]
== Слушатели

Процесс загрузки можно отслеживать с помощью следующих слушателей:

[[after-value-clear-listener]]
* `AfterValueClearListener` - вызывается при очистке значения с помощью кнопки очистки.

[[before-value-clear-listener]]
* `BeforeValueClearListener` - вызывается при нажатии на кнопку очистки.

[[file-upload-error-listener]]
* `FileUploadErrorListener` -  вызывается при неудачном завершении загрузки.

[[file-upload-finish-listener]]
* `FileUploadFinishListener` - вызывается при завершении загрузки файла.

[[file-upload-start-listener]]
* `FileUploadStartListener` - вызывается при начале загрузки файла.

[[file-upload-succeed-listener]]
* `FileUploadSucceedListener` - вызывается при удачном завершении загрузки.

[[value-change-listener]]
* `ValueChangeListener` - вызывается при изменении значения поля.

[[attributes]]
== Атрибуты

[[file-storage-put-mode]]
=== fileStoragePutMode

По умолчанию атрибуту `fileStoragePutMode` задано значение `IMMEDIATE`. Можно управлять сохранением файла программно, задав атрибуту `fileStoragePutMode` значение `MANUAL`:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=manually-controlled]
----

Определите в контроллере экрана сам компонент и интерфейс `TemporaryStorage`. Затем подпишитесь на <<listeners,события>> удачных загрузок или ошибок:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filestorageuploadfield/FileStorageUploadFieldScreen.java[tags=manually]
----

<1> Здесь при необходимости можно получить загруженный файл из временного хранилища.
<2> Здесь с файлом можно делать что угодно.
<3>	Сохраните файл в FileStorage.

Компонент загружает файл во временное хранилище и вызывает слушатель `FileUploadSucceedEvent`.

//todo add link to FileStorage
Метод `TemporaryStorage.putFileIntoStorage()` используется для перемещения загружаемого файла из временного хранилища клиентского уровня в FileStorage. Параметрами этого метода являются идентификатор и имя файла. Оба этих параметра предоставляет `FileStorageUploadField`.

CAUTION: Событие `ValueChangedEvent` не срабатывает автоматически после загрузки или очистки `FileStorageUploadField` в режиме `MANUAL`, так как значение `FileRef` может быть получено только после загрузки файла в постоянное хранилище.

[[file-storage]]
=== fileStorage

Атрибут `fileStorage` позволяет указать имя `FileStorage`, в который будет помещен загруженный файл.

[[drop-zone]]
=== dropZone

//todo add link to box layout
Атрибут `dropZone` используется для указания `BoxLayout`, который будет использован в качестве целевой площадки для перетаскивания файлов извне браузера. Зона перетаскивания может занимать всю площадь диалогового окна. Выбранный контейнер будет подсвечиваться, когда пользователь переносит над ним файлы, без наведения файла контейнер не отображается.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=dynamic-drop-zone]
----

image::vcl/components/dynamic-file-storage-upload-field.png[align="center"]

Чтобы сделать область `dropZone` статической и отображать ее постоянно, необходимо назначить ее контейнеру готовый стиль `dropzone-container`. В этом случае контейнер необходимо оставить пустым, поместив в него только текстовый компонент `label`:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=static-drop-zone]
----

[[drop-zone-prompt]]
=== dropZonePrompt

Атрибут `dropZonePrompt` позволяет задать текст, который будет отображаться при перетаскивании на окно файла.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=drop-zone-prompt]
----

[[paste-zone]]
=== pasteZone

Атрибут `pasteZone` используется для указания контейнера, который будет использован для обработки нажатий горячих клавиш вставки, когда текстовое поле внутри этого контейнера находится в фокусе. Для этого установите для атрибута `pasteZone` значение id контейнера. Это свойство поддерживается семейством браузеров на базе Chromium.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=paste-zone]
----

[[file-size-limit]]
=== fileSizeLimit

Максимальный размер загрузки определяется свойством приложения xref:app-properties.adoc#jmix-ui-component-upload-field-max-upload-size-mb[jmix.ui.component.uploadFieldMaxUploadSizeMb] и по умолчанию равен 20 МБ. При выборе файла большего размера появится соответствующее сообщение, и загрузка будет прервана. Чтобы изменить максимальный размер загрузки для конкретного `fileStorageUploadField`, используйте атрибут `fileStorageUploadField`, который позволяет установить максимально допустимый размер файла, указанный в байтах.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=file-size]
----

[[permitted-extensions]]
=== permittedExtensions

Атрибут `permittedExtensions` может быть использован для установки "белого списка" допустимых расширений загружаемых файлов. Значением атрибута должен быть набор расширений с лидирующими точками, разделенных запятыми.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=permitted-extensions]
----

[[accept]]
=== accept

Атрибут `accept` может быть использован для установки маски расширений файлов в диалоге выбора файла. Пользователи будут иметь возможность выбрать "All files" и загрузить произвольные файлы.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=accept]
----

[[show-file-name]]
=== showFileName

Атрибут `showFileName` управляет отображением имени загруженного файла рядом с кнопкой загрузки. По умолчанию `false`.

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=file-name]
----

[[upload-button-attributes]]
=== Атрибуты uploadButton

Следующие атрибуты позволяют задать свойства кнопки загрузки:

[[upload-button-caption]]
* `uploadButtonCaption`

[[upload-button-icon]]
* `uploadButtonIcon`

[[upload-button-description]]
* `uploadButtonDescription`

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=upload-attributes]
----

[[clear-button-attributes]]
=== Атрибуты clearButton

Следующие атрибуты позволяют задать свойства кнопки очистки:

[[show-clear-button]]
* `showClearButton`

[[clear-button-caption]]
* `clearButtonCaption`

[[clear-button-icon]]
* `clearButtonIcon`

[[clear-button-description]]
* `clearButtonDescription`

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filestorageuploadfield/file-storage-upload-field-screen.xml[tags=clear-attributes]
----

[[methods]]
== Методы

* `getFileId()` - возвращает `id` загруженного файла в `TemporaryStorage`.
* `getFileName()` - возвращает подпись, которая будет отображаться в ссылке для загрузки файла рядом с кнопкой загрузки.

[[xml]]
== Все XML-атрибуты

<<accept, accept>> -
xref:vcl/xml.adoc#align[align] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
xref:vcl/xml.adoc#buffered[buffered] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
<<clear-button-caption,clearButtonCaption>> -
<<clear-button-description,clearButtonDescription>> -
<<clear-button-icon,clearButtonIcon>> -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/xml.adoc#data-container[dataContainer] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
<<drop-zone, dropZone>> -
<<drop-zone-prompt,dropZonePrompt>>
xref:vcl/xml.adoc#editable[editable] -
xref:vcl/xml.adoc#enable[enable] -
<<file-size-limit,fileSizeLimit>> -
<<file-storage-put-mode,fileStoragePutMode>> -
<<file-storage,filestorage>> -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<paste-zone, pasteZone>> -
<<permitted-extensions, permittedExtensions>> -
xref:vcl/xml.adoc#property[property] -
xref:vcl/xml.adoc#required[required] -
xref:vcl/xml.adoc#required-message[requiredMessage] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
<<show-clear-button, showClearButton>> -
<<show-file-name, showFileName>> -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#tab-index[tabindex] -
<<upload-button-caption, uploadButtonCaption>> -
<<upload-button-description, uploadButtonDescription>> -
<<upload-button-icon, uploadButtonIcon>>
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]