= Filter Components
:page-aliases: backoffice-ui:vcl/components/filter-components.adoc

xref:vcl/components/filter.adoc[Filter] 可以使用特殊的过滤器组件作为条件。过滤器组件需要实现 `FilterComponent` 接口。

默认提供三种过滤器组件：

* <<property-filter,PropertyFilter>>
* <<jpql-filter,JpqlFilter>>
* <<group-filter,GroupFilter>>

可以注册自己的过滤器组件，参阅 <<filter-component-registration,过滤器组件注册>>。

[[property-filter]]
== PropertyFilter

`PropertyFilter - 属性过滤器` 组件可以用在 `Filter` 组件内或单独使用。

下面例子演示了如何使用 XML 描述中的 `PropertyFilter` 创建设计时配置：

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=data-start;customersDc;data-end;layout-start;property-filter;layout-end]
----

还可以在界面控制器类中创建设计时配置：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filter/FilterScreen.java[tags=inject-ui-components;inject-single-filter-support;inject-pfdtc-filter;on-init-start;property-filter-design-time;on-init-end]
----

<1> 添加一个设计时配置，id 为 `javaDefaultConfiguration`，名称为 `Default configuration`。
<2> 创建 `PropertyFilter` 组件，并设置其属性。
<3> 通过给定的 metaClass、实体属性和运算符生成过滤器值组件。
<4> 将创建的属性过滤器添加至 `javaDefaultConfiguration` 配置中。
<5> 将 `javaDefaultConfiguration` 设置为当前配置。

更多信息请参阅 xref:vcl/components/property-filter.adoc[PropertyFilter]。

[[jpql-filter]]
== JpqlFilter

`JpqlFilter - JPQL 过滤器` 是一个 UI 组件，用于过滤从 `DataLoader` 返回的实体。组件包含 JPQL 表达式，表达式会被添加在数据加载器查询语句的 `from` 和 `where` 部分。设置条件的布局由组件自动完成。一个 `JpqlFilter` 布局一般包含一个标题和一个用于编辑条件值的字段。该组件只能用在 `Filter` 组件内部。

下面示例演示如何使用 `JpqlFilter` 创建设计时配置：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=window-start;data-start;customersDc;data-end;layout-start;filter-jpql-filter-start;filter-jpql-filter-simple;filter-jpql-filter-end;layout-end;window-end]
----
<1> 需要添加 JPQL 条件命名空间
<2> 定义一个 JPQL 条件，`join` 元素可选，`where` 元素必需。

配置 JPQL 条件，需在 `jpqlFilter` 内定义 `condition` 元素，内部可使用必需的 xref:vcl/components/filter.adoc#jpql-conditions-where[where] 元素和可选的 xref:vcl/components/filter.adoc#jpql-conditions-join[join] 元素。下面例子中，使用 `join` 和 `where` 元素创建 `jpqlFilter`：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=filter-jpql-filter-start;filter-jpql-filter-join-where;filter-jpql-filter-end]
----

`filter` 组件内部的 `jpqlFilter` 属性设置要点：

[[jpql-filter-caption]]
* 用 `caption` 属性可以配置过滤器中显示的条件名称。

[[jpql-filter-default-value]]
* 用 `defaultValue` 属性设置过滤器条件的默认值。

[[jpql-filter-has-in-expression]]
* 如果 JPQL 表达式包含 `in (?)` 条件，则 `hasInExpression` 属性应该设置为 `true`。此时，应用程序会使用 xref:vcl/components/values-picker.adoc[ValuesPicker] 组件，以便用户能输入多个条件参数值。
+
下面是使用 `hasInExpression` 属性的 `jpqlFilter` 示例：
+
[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=filter-jpql-filter-start;filter-jpql-filter-has-in-expression;filter-jpql-filter-end]
----

[[jpql-filter-parameter-class]]
* `parameterClass` 必需属性；指定条件参数的 Java 类。

[[jpql-filter-parameter-name]]
* `parameterName` - 查询语句中关联的参数名。可以用该名称引入配置中过滤器的相互依赖。如果未定义，则参数名随机生成。

还可以在界面控制器类中创建设计时配置：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filter/FilterScreen.java[tags=inject-ui-components;inject-single-filter-support;inject-pfdtc-filter;on-init-start;jpql-filter-design-time;on-init-end]
----

<1> 添加一个设计时配置，id 为 `javaDefaultConfiguration`，名称为 `Default configuration`。
<2> 创建 `JpqlFilter` 组件，并设置其属性。
<3> 通过给定的 metaClass 和值类型生成过滤器值组件。
<4> 将创建的 jpql 过滤器添加至 `javaDefaultConfiguration` 配置中。
<5> 将 `javaDefaultConfiguration` 设置为当前配置。

[[jpql-parameterless]]
=== 无参数过滤器

也可以定义没有参数的查询语句。设置 `parameterClass` 的值为 `java.lang.Void`，并使用 `java.lang.Boolean` 作为值：

* `true` 表示 `where` 和 `join` 的 JPQL 语句会添加至数据加载器的查询语句中。

* `false` 则不会加载 `where` 和 `join` 中的语句。

示例：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=filter-without-params]
----
<1> `parameterClass="java.lang.Void"` 表示过滤器无参数，`defaultValue="true"` 表示默认会将 `where` 和 `join` 表达式会添加至数据加载器的查询语句中
<2> 定义 JPQL 条件，使用可选的 `join` 元素和必要的 `where` 元素。

下面是在界面控制器中创建无参数 JPQL 过滤器的示例：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filter/FilterScreen.java[tags=inject-parameterless-filter;on-init-start;parameterless-filter-design-time;on-init-end]
----

无参数的 JPQL 过滤器配置也可以在运行时创建：

image::vcl/components/jpql-parameterless.png[align="center"]

[[group-filter]]
== GroupFilter

`GroupFilter - 组合条件过滤器` 组件是一个组合组件，用带有 xref:vcl/containers/responsive-grid-layout.adoc[ResponsiveGridLayout] 的 xref:vcl/containers/group-box-layout.adoc[GroupBoxLayout] 作为根布局容器。该组件用在需要将多个条件组合成一个逻辑组时（使用逻辑运算符 `AND` 或 `OR`）。组件只能在 `Filter` 组件内部使用。

下面示例演示如何使用 `GroupFilter` 创建设计时配置：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/filter/filter-screen.xml[tags=filter-group-filter]
----

[[group-filter-operation]]
`operation` 属性必需。可以用两个逻辑运算符：

* `AND` 是默认运算符
* `OR`

也可以在界面控制器中创建设计时配置：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/filter/FilterScreen.java[tags=inject-ui-components;inject-single-filter-support;inject-pfdtc-filter;on-init-start;group-filter-design-time;on-init-end]
----

<1> 添加一个设计时配置，id 为 `javaDefaultConfiguration`，名称为 `Default configuration`。
<2> 创建 `GroupFilter` 组件，并设置其属性。
<3> 为 `groupFilter` 设置 `OR` 逻辑运算符。
<4> 创建 `PropertyFilter` 组件，并设置其属性。
<5> 添加 `pointsPropertyFilter` 至 `groupFilter`。
<6> 添加 `hobbyPropertyFilter` 至 `groupFilter`。
<7> 将创建的组过滤器添加至 `javaDefaultConfiguration` 配置。
<8> 通过参数名为 `javaDefaultConfiguration` 配置设置 `pointsPropertyFilter` 的默认值。

[[filter-component-registration]]
== 注册过滤器组件

如需创建并注册 UI 过滤器组件，需要以下对象：

* 一个组件类 - UI 组件，展示在 `Filter` 组件内。组件类需要继承 `FilterComponent` 类。参考 `PropertyFilter` 类作为示例。
* 一个模型类 - 非持久化类，保存过滤器组件的状态。模型类用来保存过滤器组件状态至数据库并在运行时展示和修改过滤器组件。模型类需要继承 `FilterCondition` 类。参考 `PropertyFilterCondition` 类作为示例。
* 一个转换器类 - 在组件和模型之间转换。转换器类需实现 `FilterConverter` 接口。
* 一个编辑界面 - 模型编辑界面。如果为指定标识符，则使用默认的标识符（例如，`modelName.edit`、`PropertyFilterCondition.edit`）。

`PropertyFilter` 注册示例：

[source,indent=0]
----
    @Bean
    public FilterComponentRegistration registerPropertyFilter() {
        return FilterComponentRegistrationBuilder.create(PropertyFilter.class,
                PropertyFilterCondition.class,
                PropertyFilterConverter.class)
                .withEditScreenId("ui_PropertyFilterCondition.edit")
                .build();
    }
----

所有注册的过滤器组件都在 `Add Condition（添加条件）` 对话框的 xref:vcl/components/filter.adoc#registered-filters-popup-button[弹窗按钮] 中显示。

可以替换 Jmix 框架中注册的过滤器组件为自定义的组件，只需在 `FilterComponentRegistration` bean 使用 `@Order` 注解（例如，需要增加过滤器保存的模型属性集合时）。

[[xml]]
== XML 属性

include::../xml-studio-tip.adoc[]

[[xml-property-filter]]
=== PropertyFilter XML 属性

参阅 xref:vcl/components/property-filter.adoc#xml[PropertyFilter XML 属性]。

[[xml-jpql-filter]]
=== JpqlFilter XML 属性

xref:vcl/xml.adoc#align[align] -
<<jpql-filter-caption,caption>> -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/components/property-filter.adoc#default-value[defaultValue] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
xref:vcl/xml.adoc#editable[editable] -
xref:vcl/xml.adoc#enable[enable] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
<<jpql-filter-has-in-expression,hasInExpression>> -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<jpql-filter-parameter-class,parameterClass>> -
<<jpql-filter-parameter-name,parameterName>> -
xref:vcl/xml.adoc#required[required] -
xref:vcl/xml.adoc#required-message[requiredMessage] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#tab-index[tabIndex] -
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]

[[xml-group-filter]]
=== GroupFilter XML 属性

xref:vcl/xml.adoc#align[align] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
xref:vcl/xml.adoc#enable[enable] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
<<group-filter-operation,operation>> -
xref:vcl/components/property-filter.adoc#operation-caption-visible[operationCaptionVisible] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]
