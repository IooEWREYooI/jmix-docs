= EntitySuggestionField
:page-aliases: backoffice-ui:vcl/components/entity-suggestion-field.adoc

++++
<div class="jmix-ui-live-demo-container">
    <a href="https://demo.jmix.io/sampler/#main/sample?id=entitysuggestionfield-dataaware" class="live-demo-btn" target="_blank">在线示例</a>
</div>
++++

`EntitySuggestionField - 实体建议控件` 用于根据用户输入的字符串搜索实体实例。当用户点击右侧的按钮时，执行对应的操作。

`EntitySuggestionField` 是一个输入控件，当用户输入几个字符时，如果能匹配上一些选项，则会展示匹配选项的下拉列表。`EntitySuggestionField` 在输入每个符号之后刷新选项列表。

选项列表根据应用程序开发者定义的逻辑在后台服务端加载。

事实上，`EntitySuggestionField` 是 xref:vcl/components/suggestion-field.adoc[SuggestionField] 和 xref:vcl/components/entity-picker.adoc[EntityPicker] 的组合。

组件的 XML 名称：`entitySuggestionField`。

== 基本用法

满足下列情况可以使用 `EntitySuggestionField`：

* 用户需要选择单一实体实例。
* 建议值列表的长度对于使用 xref:vcl/components/entity-combo-box.adoc[EntityComboBox] 来说太长了。
* 希望在数据库完成高效搜索，而不是在 UI 层加载太多数据。

image::vcl/components/entity-suggestion-field.gif[align="center"]

创建数据感知的 `EntitySuggestionField`，可以使用 xref:vcl/xml.adoc#data-container[dataContainer] 和 xref:vcl/xml.adoc#property[property] XML 属性以及 <<query,query>> 元素：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitysuggestionfield/entitysuggestionfield-screen.xml[tags=data-start;instance;data-end;layout-start;basic;layout-end]
----
<1> `InstanceContainer` - `Address` 实体。
<2> 数据容器内实体的 fetch plan。

界面为具有 `country` 属性的 `Address` 实体定义了 id 为 `addressDc` 的数据容器。在 `entitySuggestionField` 元素中，通过 `dataContainer` 属性连接到 `addressDc` 数据容器，并给 `property` 属性设置了 `country` 实体属性。实体属性应该引用另一个实体，在上面的示例中就是 `Country` 实体。

[[options]]
== 选项定义

选项列表可以在 XML 描述中用 `query` 元素定义，或者在控制器中用 `SearchExecutor` 接口编程式的定义。

[[query]]
=== query 元素

`query` 是一个可选的 XML 元素，支持定义查询语句搜索建议值。

`query` 元素有下列属性：

[[entityClass]]
* `entityClass`（必需）- 实体的全限定名称。

[[fetch-plan]]
* `fetchPlan` - 可选属性，指定加载实体所需的 fetch plan。

[[escape-value-for-like]]
* `escapeValueForLike` - 启用支持搜索包含特殊字符的值：`%`、`\` 等。默认值为 `false`。

[[search-string-format]]
* `searchStringFormat` - Groovy 字符串；可以使用任何有效的 Groovy 表达式。

[[search-executor]]
=== SearchExecutor

如果未定义 `query`，则需要用 `SearchExecutor` 编程式设置选项列表。

`SearchExecutor` 是功能接口，包含单一方法：`List<E> search(String searchString, Map<String, Object> searchParams)`。

`searchString` 参数是用户输入的字符串，可用于过滤选项。

首先，在 XML 中声明一个组件：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitysuggestionfield/entitysuggestionfield-screen.xml[tags=entity-field]
----

然后为组件设置 `SearchExecutor`：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitysuggestionfield/EntitySuggestionFieldScreen.java[tags=autowired-data-manager;search-executor]
----

[TIP]
====
可以用 Studio 生成 `SearchExecutor` 实现的桩代码。
====

[WARNING]
====
`search()` 方法在后台线程中执行，因此它无法访问可视化组件或数据容器。可直接调用 xref:data-access:data-manager.adoc[DataManager] 或中间件服务；或处理并返回预先加载到界面的数据。
====

也可以使用 `escapeForLike()` 方法来搜索包含特殊符号的值：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/suggestionfield/SuggestionFieldScreen.java[tags=autowired-data-manager;escape-for-like]
----

[[meta-class]]
== metaClass

也可以在不绑定数据容器的情况下使用 `EntitySuggestionField`，比如，没有设置 `dataContainer` 和 `property`。此时，需要设置 `MetaClass` 指定实体类型，示例：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitysuggestionfield/entitysuggestionfield-screen.xml[tags=meta-class]
----

搜索逻辑通过 <<search-executor,SearchExecutor>> 定义：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitysuggestionfield/EntitySuggestionFieldScreen.java[tags=autowired-data-manager;search-executor-metaclass]
----

[[actions]]
== 操作

可以给 `EntitySuggestionField` 设置自定义或预定义的操作，操作作为按钮显示在右侧。
定义操作可以用 XML 中用内部的 `actions` 元素或者在控制器中用 `addAction()` 方法编程式添加。

[[predefined-actions]]
=== 预定义操作

如果创建无操作的 `EntitySuggestionField`，XML 加载器仅定义 `entity_lookup` 和 `entity_open` 操作。还有 `entity_clear` 和 `entity_openComposition` 操作。

如需添加其他预定义操作，例如，`entity_clear`，可以按照下面这样指定 `actions` 元素：

[source, xml,indent=0]
----
include::example$/ex1/src/main/resources/ui/ex1/screen/component/entitysuggestionfield/entitysuggestionfield-screen.xml[tags=field-with-actions]
----

`actions` 元素不会扩展但会覆盖一组标准操作。应该明确定义所有必需操作的标识符。

使用 `addAction()` 以编程方式设置标准操作。如果在组件的 XML 描述中没有内部的 `actions` 元素，就可以使用这个方法添加缺少的标准操作：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitysuggestionfield/EntitySuggestionFieldScreen.java[tags=add-action;init-start;add-action-2;init-end]
----

[[custom-actions]]
=== 自定义操作

`EntitySuggestionField` 的自定义操作与 `EntityPicker` 的 xref:vcl/components/entity-picker.adoc#custom-actions[自定义操作] 类似。

[[handlers]]
== 事件和处理器

include::../events-hanlers-generation-tip.adoc[]

[[arrow-down-handler]]
=== ArrowDownHandler

`ArrowDownEvent` 当建议值弹窗隐藏且用户按下 *向下箭头* 时发送。

可以设置自定义的处理方法并使用 `EntitySuggestionField.showSuggestions()`，该方法接收一组实体作为建议值展示：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitysuggestionfield/EntitySuggestionFieldScreen.java[tags=arrow-down]
----

[[context-help-icon-click-handler]]
=== ContextHelpIconClickHandler

参阅 xref:vcl/api.adoc#context-help-icon-click-handler[ContextHelpIconClickHandler]。

[[enter-press-handler]]
=== EnterPressHandler

参阅 `ComboBox` xref:vcl/components/combo-box.adoc#handling-user-input[处理用户输入] 部分编程式注册的示例。

`EnterPressHandler` 也可以在界面控制器中使用 `@Install` 注解声明式的定义。参阅 `EntityComboBox` xref:vcl/components/entity-combo-box.adoc#handling-user-input[处理用户输入] 部分的示例。

[[field-icon-provider]]
=== FieldIconProvider

参阅 xref:vcl/components/entity-picker.adoc#field-icon-provider[FieldIconProvider]。

[[field-value-change-event]]
=== FieldValueChangeEvent

参阅 xref:vcl/components/entity-picker.adoc#field-value-change-event[FieldValueChangeEvent]。

[[formatter]]
=== Formatter

为组件添加一个 xref:vcl/miscellaneous/formatter.adoc[formatter]。

下面的例子中，我们展示 `cityFieldFormat` 实体建议控件 `formatter` 的用法：

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/entitysuggestionfield/EntitySuggestionFieldScreen.java[tags=formatter]
----

如需以编程的方式添加 formatter，使用组件的 `addFormatter()` 方法。

[[option-caption-provider]]
=== OptionCaptionProvider

参阅 xref:vcl/api.adoc#option-caption-provider[OptionCaptionProvider]。

[[search-executor-interface]]
=== SearchExecutor

参阅 <<search-executor, SearchExecutor>>。

[[validator]]
=== Validator

参阅 xref:vcl/components/combo-box.adoc#validator[Validator]。

[[value-change-event]]
=== ValueChangeEvent

参阅 xref:vcl/api.adoc#value-change-event[ValueChangeEvent]。

[[xml]]
== EntitySuggestionField XML 属性

include::../xml-studio-tip.adoc[]

xref:vcl/xml.adoc#align[align] -
xref:vcl/components/suggestion-field.adoc#async-search-delay-ms[asyncSearchDelayMs] -
xref:vcl/xml.adoc#caption[caption] -
xref:vcl/xml.adoc#caption-as-html[captionAsHtml] -
xref:vcl/xml.adoc#caption-property[captionProperty] -
xref:vcl/xml.adoc#colspan[colspan] -
xref:vcl/xml.adoc#context-help-text[contextHelpText] -
xref:vcl/xml.adoc#context-help-text-html-enabled[contextHelpTextHtmlEnabled] -
xref:vcl/xml.adoc#css[css] -
xref:vcl/xml.adoc#data-container[dataContainer] -
xref:vcl/xml.adoc#description[description] -
xref:vcl/xml.adoc#description-as-html[descriptionAsHtml] -
xref:vcl/xml.adoc#editable[editable] -
xref:vcl/xml.adoc#enable[enable] -
xref:vcl/xml.adoc#box-expand-ratio[box.expandRatio] -
xref:vcl/xml.adoc#height[height] -
xref:vcl/xml.adoc#html-sanitizer-enabled[htmlSanitizerEnabled] -
xref:vcl/xml.adoc#icon[icon] -
xref:vcl/xml.adoc#id[id] -
xref:vcl/xml.adoc#input-prompt[inputPrompt] -
<<meta-class,metaClass>> -
xref:vcl/components/suggestion-field.adoc#min-search-string-length[minSearchStringLength] -
xref:vcl/components/suggestion-field.adoc#popup-width[popupWidth] -
xref:vcl/xml.adoc#property[property] -
xref:vcl/xml.adoc#required[required] -
xref:vcl/xml.adoc#required-message[requiredMessage] -
xref:vcl/xml.adoc#responsive[responsive] -
xref:vcl/xml.adoc#rowspan[rowspan] -
xref:vcl/xml.adoc#stylename[stylename] -
xref:vcl/components/suggestion-field.adoc#suggestions-limit[suggestionsLimit] -
xref:vcl/xml.adoc#tab-index[tabIndex] -
xref:vcl/xml.adoc#visible[visible] -
xref:vcl/xml.adoc#width[width]

== EntitySuggestionField XML 元素

<<actions,actions>> -
xref:vcl/miscellaneous/formatter.adoc[formatter] -
<<query,query>> -
xref:vcl/components/entity-combo-box.adoc#validators-element[validators]
