= Фоновые задачи

Механизм фоновых задач предназначен для асинхронного выполнения длительных операций на клиентском уровне без заморозки пользовательского интерфейса.

[[basics]]
== Основы
Выполните следующие действия для использования фоновых задач:

. Опишите задачу как наследника абстрактного класса `BackgroundTask`. В конструктор задачи необходимо передать ссылку на контроллер экрана, с которым будет связана задача, и значение таймаута ее выполнения.
+
Если экран указан, то при его закрытии пользователем активная задача будет прервана. Кроме того, задача будет автоматически прервана по истечении указанного таймаута.

. Реализуйте задачу в методе `BackgroundTask.run()`.

. Создайте объект управления задачей − `BackgroundTaskHandler`. Для этого экземпляр задачи необходимо передать методу `handle()` бина `BackgroundWorker`. Ссылку на `BackgroundWorker` можно получить инжекцией в контроллер экрана, с помощью `ApplicationContext`.

. Запустите задачу, вызвав метод `execute()` объекта `BackgroundTaskHandler`.

[WARNING]
Метод `BackgroundTask.run()` нельзя использовать для чтения/изменения состояния компонентов UI или контейнеров данных: вместо этого используйте методы `done()`, `progress()`, и `canceled()`. При попытке установить значение для компонента UI из фонового потока будет выброшено исключение `IllegalConcurrentAccessException`.

Ниже приведен пример запуска фоновой задачи и отслеживания ее выполнения с помощью компонента `ProgressBar`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/component/progressbar/ProgressBarScreen.java[tags=background-tasks]
----

<1> Задача, для выполнения которой требуется время. Метод `run()` выполняется в отдельном потоке.
<2> Метод `progress()` выполняется в потоке пользовательского интерфейса, поэтому здесь мы можем обновить визуальные компоненты.

[[background-task]]
== Класс BackgroundTask

`BackgroundTask<T, V>` – это параметризованный класс:

1. `T` − тип объектов, показывающих прогресс задачи. Объекты этого типа передаются в метод `progress()` задачи при вызове `TaskLifeCycle.publish()` в рабочем потоке.

2. `V` − тип результата задачи, передаваеый в метод `done()`. Его также можно получить вызовом метода `BackgroundTaskHandler.getResult()`, что приведет к ожиданию завершения задачи.

Объекты `BackgroundTask` не имеют состояния. Если при реализации конкретного класса задачи не заводить полей для хранения промежуточных данных, то можно запускать несколько параллельно работающих процессов, используя единственный экземпляр задачи.

[[background-task-methods]]
== Методы BackgroundTask

Подробная информация о методах для классов `BackgroundTask`, `TaskLifeCycle`, `BackgroundTaskHandler` предоставлена в Javadocs.

[[run]]
=== run()

Этот метод вызывается в отдельном рабочем потоке для выполнения задачи.

Метод `run()` задачи должен поддерживать возможность прерывания извне. Для этого в долгих процессах желательно периодически проверять флаг `TaskLifeCycle.isInterrupted()`, и соответственно завершать выполнение. Кроме того, нельзя тихо проглатывать исключение `InterruptedException` (или вообще все исключения). Вместо этого нужно либо вообще не перехватывать его, либо выполнять корректный выход из метода.

Метод `isCancelled()` возвращает `true`, если задача была прервана вызовом метода `cancel()`.

[[canceled]]
=== canceled()

Этот метод вызывается только в случае управляемой отмены задачи, то есть при вызове `cancel()` у `TaskHandler`.

[[progress]]
=== progress()

Этот метод вызывается в потоке UI при изменении значения прогресса, например, после вызова метода `taskLifeCycle.publish()`.

[[done]]
=== done()

Этот метод вызывается в потоке UI, когда задача завершена.

[[handle-timeout-exception]]
=== handleTimeoutException()

Этот метод вызывается в потоке UI, когда истекает время ожидания задачи. Задача останавливается без уведомления при закрытии окна, в котором она выполняется.

[[handle-exception]]
=== handleException()

Этот метод вызывается в потоке UI при возникновении каких-либо исключений.

[[notes-and-tips]]
== Примечания и советы

1. Для показа пользователю модального окна с прогрессом и кнопкой *Cancel* используйте метод `dialogs.createBackgroundWorkDialog()`. Для окна можно задать режим отображения прогресса и разрешить или запретить отмену фоновой задачи.
+
//todo BackgroundTaskWrapper
// Ни Глеб, ни Роман не знают каким классом был заменен BackgroundTaskWrapper. Сказали уточнить у Влада, но он пока что в отпуске. Как выйдет надо будет поправить и сделать usage example.
// 2. Объект `BackgroundHandler` можно запускать (т.е. вызывать его метод `execute()`) только один раз. Если требуется частый перезапуск задачи, то используйте класс `BackgroundTaskWrapper`.
+
2. Если внутри потока задачи необходимо использовать некоторые значения визуальных компонентов, то нужно реализовать их получение в методе `getParams()`, который выполняется в потоке UI один раз при запуске задачи. В методе `run()` эти параметры будут доступны через метод `getParams()` объекта `TaskLifeCycle`.
3. На выполнение фоновых задач влияют свойства приложения xref:app-properties.adoc#jmix.ui.background-task-timeout-check-interval[jmix.ui.background-task-timeout-check-interval] и xref:app-properties.adoc#jmix.ui.background-task.threads-count[jmix.ui.background-task.threads-count].

[[usage-example]]
== Пример использования

Часто при запуске фоновых задач появляется необходимость отображения простого UI:

1. Показать пользователю, что запрошенное действие находится в процессе выполнения.
2. Дать пользователю возможность прервать запрошенное долгое действие.
3. Показать процент выполнения, если его можно определить.

Вы можете сделать это с помощью метода `createBackgroundWorkDialog()` интерфейса xref:dialogs.adoc[Dialogs].

В качестве примера рассмотрим следующую задачу по разработке:

1. Некоторый экран содержит таблицу, отображающую список клиентов, с включенным множественным выделением.
2. По нажатию кнопки система должна послать письма-напоминания выбранным клиентам, без блокировки UI и с возможностью прервать действие.

image:background-tasks/emails.GIF[]

[source,java,indent=0]
----
include::example$/ex1/src/main/java/ui/ex1/screen/backgroundtasks/BackgroundTasksScreen.java[tags=background-tasks-email]
----
<1> Запустить задачу, показать модальное окно с прогрессом и установить опции диалога:
- заголовок диалога;
- сообщение диалога;
- общее количество элементов для индикатора выполнения;
- показывать прогресс в процентах или нет;
- показывать кнопку *Cancel* или нет.
<2> Прогресс задачи измеряется в `Integer` (число обработанных элементов таблицы), а тип результата – `Void`, потому что эта задача не производит результата.
<3> Выбранные элементы таблицы сохраняются в переменную, которая инициализируется в конструкторе задачи. Это необходимо, потому что метод `run()` исполняется в фоновом потоке и не может обращаться к UI компонентам.
<4> Установить таймаут равный 10 минутам.
<5> Периодически проверяется `isCancelled()`, чтобы задача завершилась сразу после того, как пользователь нажмет кнопку *Cancel*.
<6> Отправить письмо. Подробнее об отправке email читайте xref:email:index.adoc[здесь].
<7> Обновить индикатор прогресса после каждого посланного письма.
