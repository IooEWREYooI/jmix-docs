[[quick_start]]
= Начало работы с Reports
:page-aliases: reports:quick-start.adoc

Данный раздел содержит инструкции по использованию мастера отчетов и редактора отчетов. Для удобства работы дополнение Reports поставляется с мастером – визуальным инструментом для быстрого создания отчетов, включая xref:creation/data-structure.adoc[структуру данных] и xref:creation/templates.adoc[дизайн шаблонов].

Приводимые в этом разделе примеры основаны на приложении Library, исходный код которого доступен на https://github.com/jmix-framework/jmix-samples/tree/main/reports-sample[GitHub^].

[[project_setup_report]]
== Настройка проекта

. Загрузите и распакуйте исходный репозиторий приложения Jmix samples или клонируйте его с помощью git:
+
----
git clone https://github.com/jmix-framework/jmix-samples
----
. Откройте проект *jmix-samples*, как описано в разделе xref:studio:project.adoc#opening-existing-project[Открытие существующего проекта].
. Выберите конфигурацию *Reports-sample Jmix Application* и запустите приложение, как описано в xref:studio:project.adoc#starting-application[Запуск приложения].
. Войдите в приложение *Library*, указав имя пользователя и пароль `admin` / `admin`.

Чтобы запустить мастер, откройте xref:report-browser.adoc[Браузер отчетов] и нажмите *Create* -> *Using wizard*.

image::reports_wizard_main.png[align="center", width="566"]

С помощью мастера можно создать три типа отчетов:

. Отчет для одной сущности.
. Отчет для списка заданных сущностей.
. Отчет для списка сущностей, отфильтрованных по запросу.

Разработка отчета – это трехэтапный процесс:

. Создание структуры данных отчета.
. Редактирование областей отчета.
. Сохранение отчета.

Созданный отчет можно изменить обычным способом с помощью редактора отчетов и запустить через xref:run-report.adoc#run_common[общий браузер отчетов] или с помощью специальных xref:run-report.adoc#run_actions[действий] (`ListPrintFormAction`, `EditorPrintFormAction` и т.д.).

[[single_entity_report]]
== Создание отчетов с помощью мастера

Сначала рассмотрим, как сгенерировать отчет с записями об авторах для данной книги `Book`. В нем будет содержаться обзор основных данных и авторов этой книги.

В этом случае шаблоном документа будет документ Word. Однако целевым документом будет PDF-файл.
Отчет будет иметь следующие настройки по умолчанию:

* Сущность отчета: `Book` (`jmxrpr_Book`).
* Тип шаблона: xref:creation/templates.adoc#template_doc[DOCX].
* Имя отчета: `Book Record`.
* Тип отчета: `Report for single entity`.

image::single_entity_step_1.png[align="center", width="802"]

[[defining-attributes]]
=== Определение атрибутов

Укажите атрибуты сущности `Book` и связанной сущности `LiteratureType`, которые должны быть отражены в отчете: `Book.Name`, `Book.Summary`, `Book.Literature type.Name`. Эти атрибуты образуют так называемую "простую область".

Нажмите *OK*, чтобы перейти ко второму этапу – редактированию областей отчета.

Появившийся экран содержит список именованных областей – полос, в которых отображаются связанные данные. Мастер позволяет добавить в шаблон несколько областей обычного текста для отображения различных наборов данных.

Набор атрибутов сущности, загруженных в определенную область, можно изменить, щелкнув по ссылке, представленной в виде списка выбранных атрибутов. Также новую область можно добавить кнопкой *Add simple region*.

Если сущность содержит атрибуты коллекции, появится кнопка *Add tabulated region*. Это позволяет добавить область для отображения табличных данных.

Итак, чтобы отобразить список связанных авторов данной сущности `Book`, мы создадим еще одну полосу данных. Нажмите на кнопку *Add tabulated region*.

image::single_entity_step_2.png[align="center", width="802"]

Выберите атрибуты `Book.Authors.First name` и `Book.Authors.Last name`.

Когда все области отчета настроены, можно переходить к третьему этапу: сохранению отчета. На этом этапе вы можете просмотреть полный шаблон отчета или изменить имя и формат выходного файла на один из доступных типов. Выберите тип вывода отчета в формате PDF.

После нажатия кнопки *Save* откроется стандартный редактор отчетов для  точной настройки обычным способом.

[[output-document]]
=== Настройка выходного документа

Выходной документ для этого отчета содержит один шаблон, изначально определенный с помощью мастера создания отчетов. Тип вывода – PDF, в то время как файл шаблона – DOCX.

image::configure-template.png[align="center", width="730"]

Нажмите на имя файла шаблона и откройте его в, например, LibreOffice. Измените xref:reports:creation/templates.adoc#template_doc[содержимое шаблона] в соответствии со скриншотом:

image::edit-template-for-report1.png[align="center", width="1244"]

[NOTE]
====
Шаблоны отчетов можно найти в демонстрационном проекте в разделе https://github.com/jmix-framework/jmix-samples/tree/main/reports-sample/src/main/resources/com/company/library/reports/templates[reports/templates^].
====

Также можно определить имя файла выходного документа. Оно может быть либо статическим, либо настроенным программно.

В нашем случае имя файла для книги с названием "The 20th Century Art Book" должно выглядеть следующим образом: `Book Record - The 20th Century Art Book.pdf`.

Для этого мы можем настроить шаблон, который ссылается на определенную полосу: `${Root.title}.pdf`.

`Root.title` ссылается на значение `title` полосы данных `Root`. Набор данных на основе groovy определит значение атрибута `title` следующим образом:

[source,groovy,indent=0]
----
def bookName = params["entity"]["name"] //<1>

return [
    ["title" : "Book Record - $bookName"] //<2>
]
----
<1> Переменная `params` предоставляет доступ к различным внешним параметрам. `params["entity"]` ссылается на выбранный экземпляр книги.
<2> Список Maps должен быть возвращен из этого скрипта groovy. Под ключом `title` он поместит имя целевого файла.

Результат использования набора данных на основе groovy выглядит следующим образом:

image::title-band-for-report1.png[align="center", width="1177"]

[[running-report]]
=== Запуск отчета с экрана

Запуск отчета можно включить в браузере `Book`. Для этого мы объявим стандарт xref:run-report.adoc#list_print_form_action[ListPrintFormAction] в дескриптор экрана `book-browse.xml`:

[source, xml,indent=0]
----
<actions>
    ...
    <action id="listPrintForm"
            type="listPrintForm"
            caption="Print details"/> <--1-->
    ...
</actions>
...
<buttonsPanel id="buttonsPanel" alwaysVisible="true">
    ...
    <button id="printBtn" action="booksTable.listPrintForm"/> <--2-->
    ...
</buttonsPanel>
----
<1> Атрибут `type` определяет конкретный тип действия `listPrintForm`.
<2> Добавляет кнопку с действием "Запустить отчет".

Затем мы должны связать наш отчет с браузером `Book`. Откройте редактор отчетов, перейдите на вкладку *Roles and Screens* и добавьте экран `Book.browse` из выпадающего списка в таблицу ниже:

image::single_entity_screens.png[align="center", width="1169"]

Теперь вы можете запустить отчет для любой книги, просто выбрав ее в таблице и нажав кнопку *Print details*.

image::single_entity_running.png[align="center", width="1031"]

Результат выглядит следующим образом:

image::single_entity_result.png[align="center", width="1062"]

[[creating-report-manually]]
== Создание отчета вручную

Давайте создадим отчет со списком публикаций, сгруппированных по типам литературы и книгам.

Верхняя часть отчета содержит информацию о создателе отчета и дату составления. Ниже приведена таблица с последовательной группировкой по типу литературы и книгам.

Отчет будет иметь следующие настройки по умолчанию:

* Тип шаблона: xref:creation/templates.adoc#template_xls[XLSX].
* Название отчета: `Publications grouped by types and books`.
* Тип отчета: ручной, созданный с помощью редактора отчетов.

[[creating-template]]
=== Создание шаблона

Создайте шаиблон `Template for publications by type.xlsx` для отчета с помощью Microsoft Office или LibreOffice.

image::template-for-report2.png[align="center", width="1552"]

Этот шаблон отчета содержит именованные области (`type`, `book`, `publisher`) для трех наборов данных зависимых полос и, дополнительно, именованные области для заголовка столбца (`tableheader`) и для дополнительной информации об отчете (`header`).

[NOTE]
====
Шаблоны отчетов можно найти в демонстрационном проекте в разделе under https://github.com/jmix-framework/jmix-samples/tree/main/reports-sample/src/main/resources/com/company/library/reports/templates[reports/templates^].
====

[[report-structure]]
=== Определение структуры отчета

Создайте отчет, используя всплывающую кнопку *New*.

Откроется вкладка xref:creation/data-structure.adoc[Report structure] редактора отчетов.

Определите название отчета – `Publications grouped by types and books`.

image::structure-for-report2.png[align="center", width="985"]

Нажмите на кнопку *Create template* button.

Откроется диалоговое окно *Template editor*. Загрузите созданный шаблон и определите шаблон выходного имени.

image::upload-template-for-report2.png[align="center", width="730"]

Теперь создадим полосы отчета.

* *header* содержит набор данных со скриптом Groovy, который выводит имя текущего пользователя и текущую дату.
+
[source, groovy,indent=0]
----
import io.jmix.core.security.CurrentAuthentication;
import io.jmix.core.TimeSource;

def user = currentAuthentication.getUser().getUsername();
def currentDate = timeSource.currentTimestamp();

return [["generated_by":user, "generated_when":currentDate]]
----

* *tableheader* пуст. Используется для отображения заголовка таблицы.
* *type* выводит список типов литературы, выполнив следующий запрос JPQL:
+
----
select b.literatureType.id as typeId,
b.literatureType.name as type
from jmxrpr_Book b
----
* *book* является дочерним по отношению к *type*. Выводит книги, выполнив следующий запрос JPQL:
+
----
select b.id as bookId,
b.name as bookName
from jmxrpr_Book b
where b.literatureType.id = ${type.typeId}
----
+
Этот запрос использует родительское поле полосы `typeId` в качестве параметра. Это обеспечивает зависимость между родительскими и дочерними полосами.
* *publisher* является дочерним по отношению к *book*. Выводит данные о публикации книг, выполнив следующий запрос JPQL:
+
----
select bp.publisher.name as publisher,
bp.year as year,
bp.town as town
from jmxrpr_BookPublication bp
where bp.book.id = ${book.bookId}
----
+
Этот запрос использует родительское поле полосы `BookID` в качестве параметра.

В редакторе отчет выглядит следующим образом:

image::report-structure-report2.png[align="center", width="1177"]

Как только отчет сохранен, вы можете запустить его через xref:run-report.adoc#run_common[общий браузер отчетов].

Результат выглядит следующим образом:

image::output-report2.png[align="center", width="1318"]
