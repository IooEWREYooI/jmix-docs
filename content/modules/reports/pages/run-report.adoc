= Запуск отчетов

[[run_common]]
== Запуск из браузера отчетов

Самый простой способ запуска отчетов – из универсального браузера, доступного на экране *Reports* -> *Run Reports*. Пользователь должен иметь право доступа к этому экрану. Список будет содержать все отчеты, которые xref:creation/permissions.adoc[доступны пользователю] в соответствии с его ролью. Если отчет содержит внешние параметры, они будут запрошены в специальной форме при запуске отчета.

[[run_actions]]
== Запуск с экранов

Вы можете запускать отчеты с произвольных экранов, используя специальные действия и связанные с ними кнопки или пункты контекстного меню компонентов. В этом случае в дополнение к роли пользователя проверяется xref:creation/permissions.adoc[доступность] отчета непосредственно на этом экране.

Типы действий и примеры их использования приведены ниже.

[[run_report_action]]
* `io.jmix.reportsui.action.list.RunReportAction`` – xref:ui:actions/standard-actions.adoc[стандартное действие], которое отображает список всех доступных отчетов. Оно должно быть определено для `Button` или компонента-списка (`Table`, `DataGrid` и т.д.).
+
Ниже приведен пример использования декларативного действия для `GroupTable`:
+
[source, xml,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/screen/entity/book/book-browse.xml[tags=run-action]
----
<1> Атрибут `type` определяет конкретный тип действия `runReport`, предоставляемый фреймворком.
<2> Добавляет кнопку с действием "запустить отчет".
+
Пример программного создания действия с кнопкой, объявленной в XML-дескрипторе экрана:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/entity/town/TownBrowse.java[tags=run-report-button]
----
+
После выполнения действия откроется модальное диалоговое окно **Report Run**, в котором будут отображены отчеты, относящиеся к текущему экрану. Когда пользователь выбирает отчет из списка, отображается форма ввода параметров (если таковые были определены) и запускается отчет.

[[list_print_form_action]]
* `io.jmix.reportsui.action.list.ListPrintFormAction` – a xref:ui:actions/standard-actions.adoc[standard action] for printing reports for entity instances associated with a list component (`Table`, `DataGrid`, etc.).
+
Действие выбирает только отчеты, имеющие внешний параметр типа *Entity* или *List of entities* и в которых параметр entity type соответствует типу сущности, отображаемому компонентом-списком. Если в результате выбора доступен только один отчет, он вызывается немедленно. Если доступно несколько отчетов, пользователю предлагается их список для выбора.
+
Значение внешнего параметра передается в отчет по следующим правилам:

** Если параметр имеет тип *List of entities*, в него передается список экземпляров, выбранных в данный момент в компоненте-списке.

** Если параметр имеет тип *Entity*, а в компоненте списка выбран один экземпляр (выделена одна строка), то в отчет передается этот экземпляр.

** Если параметр имеет тип *Entity*, а в компоненте-списке выбрано несколько строк, то отчет запускается несколько раз в соответствии с количеством выбранных экземпляров. После выполнения пользователь получает единый ZIP-архив, содержащий все сгенерированные отчеты.
+
Ниже приведен пример использования декларативного действия для `GroupTable`:
+
[source, xml,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/screen/entity/author/author-browse.xml[tags=list-print-action]
----
<1> Атрибут `type` определяет конкретный тип действия `listPrintForm`, предоставляемый фреймворком.
<2> Добавляет кнопку с действием "запустить отчет".
+
Пример программного создания действия с кнопкой, объявленной в XML-дескрипторе экрана:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/entity/publisher/PublisherBrowse.java[tags=list-print-button]
----
+
После выполнения действия, если ни одна сущность не была выбрана из компонента-списка, отобразится окно подтверждения.
+
.Окно подтверждения
image::run_actions_listPrint_confirmation.png[align="center"]
+
После этого откроется модальное диалоговое окно **Run reports**, в котором будут отображены отчеты, относящиеся к текущему экрану. На этом модальном экране пользователь может запустить некоторый отчет для выбранной сущности.

[[editor_print_form_action]]
* `io.jmix.reportsui.action.list.EditorPrintFormAction` – действие, связанное с экраном редактора сущностей. Действие выбирает только отчеты, имеющие внешний параметр типа *Entity* или *List of entities* и в которых параметр entity type соответствует отредактированному типу сущности. Если в результате выбора доступен только один отчет, он вызывается немедленно. Если доступно несколько отчетов, пользователю предлагается их список для выбора.
+
Значение внешнего параметра – отредактированный экземпляр сущности – передается в отчет. Если параметр имеет тип *List of entities*, то передается список, содержащий один элемент.
+
Ниже приведен пример использования действия в кнопке, расположенной рядом со стандартными кнопками *OK* и *Cancel*:
+
--
** XML-дескриптор
+
[source, xml,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/screen/entity/book/book-edit.xml[tags=editor-print-button]
----

** Контроллер
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/entity/book/BookEdit.java[tags=editor-print-button]
----
--

[[reports-api]]
== Reports API

[[report-runner]]
=== ReportRunner

`ReportRunner` – это интерфейс, используемый для запуска отчетов. Все его методы возвращают объект `ReportOutputDocument`, содержащий результат выполнения отчета.

Ниже представлен пример использования `ReportRunner`.

. Запуск отчета на основе информации, указанной в объекте <<report-run-context,ReportRunContext>>::
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=inject-report-runner;rrc-btn2-start;report-runner-v1;rrc-btn2-end]
----
<1> `ReportRunContext` содержит сущность отчета и параметры.

. Запуск отчета по его коду и дополнительной информации, указанной с помощью fluent интерфейса:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=inject-report-runner;rr-btn1-start;report-runner-v2;rr-btn1-end]
----
<1> Точка входа во fluent интерфейс для отчета с указанным кодом.
<2> Добавляет входной параметр в сопоставление параметров.
<3> Задает код шаблона, который будет использоваться для запуска отчета.
<4> Создает экземпляр `ReportRunContext` и запускает отчет, используя этот контекст запуска.

. Запуск отчета с помощью сущности отчета и дополнительной информации, указанной с помощью fluent интерфейса:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=inject-report-runner;rr-btn2-start;report-runner-v3;rr-btn2-end]
----
<1> Задает тип выходного документа.
<2> Задает шаблон имени выходного документа.

Содержимое отчета и имя файла можно получить непосредственно из `ReportOutputDocument`:

[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=get-content]
----

[[ui-report-runner]]
=== UIReportRunner

`UiReportRunner` – это интерфейс для выполнения отчетов с экранов приложения. В дополнение к параметрам, необходимым для запуска отчета, `UiReportRunner` позволяет настроить следующие функции:

* Отображение результата выполнения отчета в браузере (в случае шаблонов-диаграмм/сводной таблицы/таблицы).
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=run-and-show]
----

* Показывать ли диалоговое окно для ввода параметров отчета перед запуском. Для этого используется `ParametersDialogShowMode`. Поддерживаются три режима:

** `YES` - отображать диалогового окна для ввода параметров отчета.
** `NO` - не отображать диалоговое окно для ввода параметров отчета.
** `IF_REQUIRED` - отображать диалогового окна для ввода параметров отчета, если:
+
*** Отчет имеет входные параметры;
*** Отчет содержит несколько шаблонов;
*** Отчет содержит один шаблон с изменяемым типом выходных данных.

* Выполнять генерацию отчетов синхронно или в фоновом режиме:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=in-background]
----

* Запуск отчета несколько раз для указанного псевдонима и значения параметра:
+
[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=run-multiple-reports]
----
+
Метод `runMultipleReports()` запускает отчет для каждого объекта из указанной коллекции. Объекты в коллекции должны иметь тот же тип, что и входной параметр с указанным псевдонимом.

[[report-run-context]]
=== ReportRunContext

Класс `ReportRunContext` хранит следующую информацию, необходимую для запуска отчета:

* Сущность `Report`;
* Сущность `ReportTemplate`: если не указано, используется шаблон по умолчанию;
* Входные параметры;
* Тип выходного документа;
* Шаблон выходного имени.

Рассмотрим примеры создания `ReportRunContext`:

[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=report-run-context-v1;report-run-context-v2]
----

[[report-zip-utils]]
=== ReportZipUtils

Интерфейс `ReportZipUtils` помогает упаковать список объектов `ReportOutputDocument` в один ZIP-архив.

[source, java,indent=0]
----
include::example$/ex2/src/main/java/reports/ex2/screen/other/RunReportScreen.java[tags=report-zip-utils]
----

// TODO cancel report #22
// [[run_cancel]]
// == Cancelling Reports Execution

// If the report execution is running as a background task, it can be interrupted by the user.

// To add the cancel option, set the xref:app-properties.adoc#jmix.reports.client.useBackgroundReportProcessing[jmix.reports.client.useBackgroundReportProcessing] property to `true`:

// [source, groovy,indent=0]
// ----
// jmix.reports.client.useBackgroundReportProcessing = true
// ----

// Thus, the window with the progress bar and the *Cancel* button will be displayed:

// .Cancel report
// image::run_cancel.png[align="center"]

// You can also set the processing timeout using the xref:app-properties.adoc#jmix.reports.client.backgroundReportProcessingTimeoutMs[jmix.reports.client.backgroundReportProcessingTimeoutMs] property:

// [source, groovy,indent=0]
// ----
// jmix.reports.client.backgroundReportProcessingTimeoutMs = 30000
// ----

// When the time is up, the task will be canceled regardless the result, and the user will receive an error message:

// .Report error
// image::run_timeout.png[align="center"]

// To cancel the report execution programmatically, use the `cancelReportExecution()` method of the `ReportService` interface that takes the identifiers of the user session and the report:

// [source, java,indent=0]
// ----
// reportService.cancelReportExecution(userSessionId, report.getId());
// ----
