[[examples]]
= Примеры отчетов

[[example_xls]]
== Пример XLS-отчета

Данный пример основан на демо-приложении *Library*. Следуйте xref:getting-started.adoc#project_setup_report[инструкциям], чтобы настроить проект, а затем создайте объекты и экраны.

В этом примере мы сгенерируем отчет для автора книги. При наличии автора в отчете будут указаны его книги, издатель каждой книги, в каком отделе библиотеки хранилась книга и сколько книг хранилось в каждом отделе. Готовый отчет выглядит следующим образом:

.Книги по авторам
image::sample1_result.png[align="center"]

. xref:creation/data-structure.adoc[Структура данных отчета].
+
--
.Структура данных отчета
image::sample1_structure.png[align="center"]

Рассмотрим полосы отчета.

* Полоса *header* – заголовок отчета. Содержит набор данных с Groovy-скриптом, выводящим значения xref:creation/parameter-and-format.adoc#parameters[внешних параметров] отчета:
+
[source, groovy,indent=0]
----
[['authorName' : (params['author'].firstName + ' ' + params['author'].lastName)]]
----

* Полоса *book* выводит список книг путем выполнения следующего SQL-запроса:
+
[source, sql,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_xls.sql[tags=book-dataset]
----
+
В данном запросе используется внешний параметр отчета – `author`. Параметр имеет тип *Entity*, однако в SQL-запросах его можно напрямую сравнивать с полями-идентификаторами сущностей, преобразование будет выполнено автоматически.

* Вложенная в *book* полоса *publisher* выводит издателей книги путем выполнения следующего SQL-запроса:
+
[source, sql,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_xls.sql[tags=publisher-dataset]
----
+
В данном запросе в качестве параметра используется поле родительской полосы – `++book_id++`. Таким образом осуществляется связь между родительской и дочерней полосами.

* Вложенная в *publication* полоса *publisher* выводит издания книги путем выполнения следующего SQL-запроса:
+
[source, sql,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_xls.sql[tags=publication-dataset]
----
+
В данном запросе в качестве параметров используются поля обоих родительских полос – `++book_id++` и `++publisher_id++`.
--

. xref:creation/parameter-and-format.adoc#parameters[Параметры] отчета.
+
На вкладке *Parameters and Formats* объявлен один внешний параметр отчета – `Author`:
+
.Параметры отчета
image::sample1_param.png[align="center"]
+
Этот параметр запрашивается у пользователя при запуске отчета. Выбор автора производится через экран `Author.browse`, имеющийся в приложении.

. xref:creation/templates.adoc#template_xls[Шаблоны] отчета.
+
На вкладке *Templates* определен один шаблон формата XLS, загруженный из файла link:{attachmentsdir}/BooksByAuthor.xls[BooksByAuthor.xls]
+
.Шаблоны отчета
image::sample1_template.png[align="center"]

. xref:creation/localization.adoc[Локализация] названия отчета.
+
На вкладке *Localization* задано название отчета для русской локали:
+
[source, properties,indent=0]
----
ru = Книги по автору
----

Вызовите отчет на исполнение из общего списка в экране *Reports* -> *Run Reports*.

[[crosstab_xls]]
== Пример перекрестного отчета

Данный пример основан на демо-приложении *Library*. Следуйте xref:getting-started.adoc#project_setup_report[инструкциям], чтобы настроить проект, а затем создайте объекты и экраны.

В этом примере мы создадим перекрестный отчет для отделов библиотеки, чтобы показать, сколько книг каждый отдел приобретал каждый месяц. Отчет расширяется как по вертикали, так и по горизонтали и агрегирует количества книг по каждому отделу и каждому месяцу:

.Готовый перекрестный отчет
image::crosstab_result.png[align="center"]

Для создания отчета выберите ориентацию полосы *Crosstab* на вкладке xref:creation/data-structure.adoc[Report structure] редактора отчетов. При выборе этой ориентации к полосе автоматически добавляются три набора данных:

. `<band_name>`*_dynamic_header* – данные из этого набора заполняют отчет значениями слева направо, то есть он ведет себя, как вертикальная полоса с заголовками столбцов матрицы.

. `<band_name>`*_master_data* – данные из этого набора заполняют отчет значениями сверху внизу, то есть он ведет себя, как горизонтальная полоса с заголовками строк матрицы.

. `<band_name>` – набор данных, названный так же, как полоса, в которой он создан. Этот набор содержит данные для заполнения ячеек матрицы.

Для этих наборов данных вы можете выбрать любой из доступных типов: xref:creation/data-structure.adoc#structure_sql[SQL], xref:creation/data-structure.adoc#structure_jpql[JPQL], xref:creation/data-structure.adoc#structure_groovy[Groovy], и т.д.

Создадим перекрестный отчет для сущности `BookInstance` из демо-приложения *Library* со следующей структурой:

.Перекрестный отчет
image::crosstab_structure.png[align="center"]

. xref:creation/data-structure.adoc[Структура] данных отчета. Есть три набора данных:
+
* `bi_dynamic_header` возвращает список названий месяцев:
+
[source, groovy,indent=0]
.bi_dynamic_header dataset
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_crosstab.groovy[]
----
+
* `bi_master_data` возвращает имена и идентификаторы отделов библиотеки, выбранных пользователем в качестве xref:creation/parameter-and-format.adoc#parameters[внешнего параметра отчета]:
+
[source, sql,indent=0]
.bi_master_data dataset
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_crosstab.sql[tags=master-data-dataset]
----
+
* Набор данных `bi` генерирует данные для заполнения ячеек матрицы, то есть сумму книг за конкретный месяц и отдел. Он использует `bi_master_data@department_id` (идентификатор покупателя) как вертикальную координату ячейки и `bi_dynamic_header@header_id` (название месяца) как горизонтальную координату, а затем заполняет ячейку суммой значений `amount`.
+
В примере ниже мы использовали два дополнительных внешних параметра: `start_date` и `end_date`, которые определяют временной диапазон заказов. Мы рекомендуем использовать xref:creation/parameter-and-format.adoc#report_parameter_validation[перекрестную валидацию] значений введенных параметров, чтобы избежать ошибок, вызванных неправильным диапазоном дат.
+
[source, sql,indent=0]
.bi dataset
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_crosstab.sql[tags=bi-dataset]
----

. xref:creation/parameter-and-format.adoc#parameters[Параметры] отчета.
+
На вкладке *Parameters and Formats* объявлены внешние параметры отчета – `selected_departments`, `start_date`, `end_date`:
+
.Параметры отчета
image::crosstab_external_params.png[align="center"]
+
Эти параметры запрашиваются у пользователя при запуске отчета. Выбор отдела производится через экран `jmxrpr_LibraryDepartment.browse`, имеющийся в приложении.

. Шаблон xref:creation/templates.adoc[отчета].
+
Теперь создадим шаблон отчета, используя Microsoft Office или LibreOffice.
+
link:{attachmentsdir}/DepartmentBooks.xls[DepartmentBooks.xls] – это пример шаблона, который выводит список `Departments` по вертикали и `Books` для каждого отдела по горизонтали, сгруппированный по месяцам создания книг.
+
Данный шаблон отчета содержит xref:creation/templates.adoc#template_xls_regions[именованные области] для всех трех наборов данных перекрестной полосы, а также именованную область для заголовка столбца: `<band_name>_header`. В нашем случае это `bi_header`.

Запустить отчет можно из общего браузера на экране *Reports* -> *Run Reports*.

[[example_jasper]]
== Пример отчета JasperReports

Данный пример основан на демо-приложении *Library*. Следуйте xref:getting-started.adoc#project_setup_report[инструкциям], чтобы настроить проект, а затем создайте объекты и экраны.

Создадим JRXML-шаблон, который выводит список публикаций книг, доступных в выбранном отделе:

.Готовый отчет
image::sample_jasper_result.png[align="center"]

. xref:creation/data-structure.adoc[Структура данных отчета].
+
--
.Структура данных отчета
image::sample_jasper_structure.png[align="center"]

Рассмотрим полосы отчета.

*  *Header* – заголовок отчета. Она содержит набор данных с Groovy-скриптом, выводящим значение xref:creation/parameter-and-format.adoc#parameters[внешнего параметра] отчета:
+
[source, groovy,indent=0]
----
[['library_department_name' : params['library_department'].name]]
----

* Полоса *Data* выводит список книг в выбранном отделе путем выполнения следующего Groovy-скрипта:
+
[source, groovy,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/sample_jasper.groovy[]
----
+
В данном запросе используется внешний параметр отчета – `library_department`. Параметр имеет тип *Entity*, однако его можно напрямую сравнивать с полями-идентификаторами сущностей, преобразование будет выполнено автоматически.
--

. xref:creation/parameter-and-format.adoc[Параметры] отчета.
+
На вкладке *Parameters and Formats* объявлен один внешний параметр отчета – `Department`:
+
.Параметры отчета
image::sample_jasper_paramters.png[align="center"]
+
Этот параметр запрашивается у пользователя при запуске отчета. Выбор отдела производится через экран `jmxrpr_LibraryDepartment.browse`, имеющийся в приложении.

. xref:creation/templates.adoc#template_jasper[Шаблон] отчета.
+
--
Создайте новый JRXML-файл (или скачайте link:{attachmentsdir}/BookAvailability.jrxml[BookAvailability.jrxml]) со следующим содержимым:

[source, xml,indent=0]
.BookAvailability.jrxml
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/BookAvailability.jrxml[]
----

Таблица в этом шаблоне привязана к дочернему источнику данных subDataset. Элемент `title` обращается к данным полосы *Header* напрямую. Вы можете заранее посмотреть, как будет выглядеть отчет, открыв шаблон в визуальном редакторе JasperReports.

Загрузите новый шаблон в приложение, выбрав любой тип вывода, и сделайте его шаблоном по умолчанию:

.Редактор шаблона
image::sample_jasper_template.png[align="center"]
--

Запустить отчет можно из общего браузера на экране *Reports* -> *Run Reports*.

[[example_html]]
== Пример отчета HTML/PDF

Данный пример основан на демо-приложении *Library*. Следуйте xref:getting-started.adoc#project_setup_report[инструкциям], чтобы настроить проект, а затем создайте объекты и экраны.

Создадим отчет кратких описаний книг с альбомной ориентацией страниц, нумерацией, а также фиксированными заголовком и подвалом на каждой странице, которые мы настроим через правила и свойства CSS. Формат вывода отчета – HTML с конвертацией в PDF:

.Готовый отчет
image::example_html_result.png[align="center"]

. xref:creation/data-structure.adoc[Структура] отчета
+
--
Создайте простой отчет без параметров. Запрос JPQL возвращает список всех книг с их локальными атрибутами: `name` and `summary`.

.Структура данных отчета
image::example_html_structure.png[align="center"]
--

. xref:creation/templates.adoc#template_html[Шаблон] отчета.

+
--
Теперь создайте файл шаблона. Определите в нем блоки заголовка и подвала, которые должны выводиться на каждой странице итогового документа PDF. Также используйте свойство CSS `page-break-before`: `always`, которое будет создавать разрыв страницы перед каждым новым блоком информации о книге.

Используйте теги *FreeMarker* для вставки данных в тело отчета. См. полную https://freemarker.apache.org/docs/[документацию^] по FreeMarker.

[source, html,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/BookSummary.html[tags=html-body]
----
--

. Правила CSS
+
--
Используйте следующий код CSS для разметки страницы PDF:

[source, css,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/BookSummary.html[tags=hf-css]
----

Также используйте следующий CSS-код для настройки отобажения страницы в формате PDF и отступов для основного содержимого отчета, чтобы избежать наложения с заголовком и подвалом:

[source, css,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/BookSummary.html[tags=body-css]
----

В итоге получился файл link:{attachmentsdir}/BookSummary.html[BookSummary.html] со следующим содержанием:

[source, html,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/BookSummary.html[tags=**]
----
--

. Создавая шаблон отчета, мы выберем тип шаблона *Freemarker*:
+
--
.Редактор шаблона
image::example_html_template.png[align="center"]

Запустить отчет можно из общего браузера на экране *Reports* -> *Run Reports*.
--

[[example_html_groovy_template]]
== HTML отчет с шаблонизатором Groovy

Данный пример основан на демо-приложении *Library*. Следуйте xref:getting-started.adoc#project_setup_report[инструкциям], чтобы настроить проект, а затем создайте объекты и экраны.

Давайте создадим отчет, который выводит список книжных публикаций для выбранного города. Формат вывода по умолчанию – HTML:

.Готовый отчет
image::html_groovy_result.png[align="center"]

. Создайте отчет с набором данных JPQL:
+
.Структура данных отчета
image::html_groovy_structure.png[align="center"]
+
Полоса `BookPublications` выводит список публикаций путем выполнения следующего JPQL запроса:
+
[source, sql,indent=0]
.BookPublications dataset
----
select
b.name as "book",
p.name as "publisher"
from jmxrpr_BookPublication bp
left join bp.book b
left join bp.publisher p
 where bp.town.id = ${town}
----
+
В запросе используется внешний параметр отчета – `town`. Параметр имеет тип *Entity*, однако его можно напрямую сравнивать с полями-идентификаторами сущностей, преобразование будет выполнено автоматически.

. Задайте xref:creation/parameter-and-format.adoc[параметр] отчета:
+
На вкладке *Parameters and Formats* объявлен один внешний параметр отчета – `Town`:
+
.Параметр отчета
image::html_groovy_parameter.png[align="center"]
+
Этот параметр запрашивается у пользователя при запуске отчета. Выбор города производится через экран `jmxrpr_Town.browse`, имеющийся в приложении.

. Создайте xref:creation/templates.adoc#template_html[шаблон] отчета:
+
Создайте новый HTML-файл (или скачайте link:{attachmentsdir}/PublicationByTown.html[PublicationByTown.html]) со следующим содержимым:
+
[source, html,indent=0]
.PublicationsTemplate
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/PublicationByTown.html[tags=**]
----
+
Для формирования заголовка отчета используется значение входного параметра: `${Root.fields.town.name}`.
+
Ниже определена переменная `bookPublications`:
+
[source, groovy,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/PublicationByTown.html[tags=bookPublications]
----
+
Эта переменная используется в теле таблицы для вывода полей отчета.
+
[source, groovy,indent=0]
----
include::example$/ex2/src/main/resources/reports/ex2/docrefs/PublicationByTown.html[tags=report-fields]
----
+
Загрузите новый шаблон в приложение, выбрав формат вывода HTML, установите переключатель *Template type* в значение *Groovy template* и сделайте его шаблоном по умолчанию:
+
.Редактор шаблона отчета
image::html_groovy_template.png[align="center"]

Запустить отчет можно из общего браузера на экране *Reports* -> *Run Reports*.
