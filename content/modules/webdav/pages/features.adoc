= WebDAV Features

The add-on functionalities are available only for fields of the `WebdavDocument` type.

Let's create a `Contract` entity with the `number` attribute of the `String` type.

Open entity designer and create a new attribute - `document`. Select `WebdavDocument` datatype from the list.

image::webdav-document.png[]

The source code of the `Contract` entity will look like this:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/webdav/ex1/entity/Contract.java[tags=entity-start;attributes;webdav-document;entity-end]
----

The figure below shows how the `Document` field is displayed.

image::webdav-document-field.png[]

== WebdavSupport Annotation

The `@WebdavSupport` annotation can be specified for fields of the `WebdavDocument` type. Using this annotation, you can disable versioning support for a particular field. All attributes of the `WebdavDocument` type support versioning by default.

For example, let's set up `@WebdavSupport` for a field of the `WebdavDocument` type.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/webdav/ex1/entity/Contract.java[tags=entity-start;webdav-document-versioning;entity-end]
----

[[links]]
== Links

The add-on enables you to receive a link to a document published on a web portal or passed to third parties. When opening the link, your browser requests credentials for accessing the document or document version. After successful authorization, the document or document version is opened in a desktop version of an external application.

[[web-dav-document-browser]]
== WebDAV Document Browser

Go to the *Administration -> WebDAV document browser* screen to view and manage documents.

After that, the *Document browser* screen is opened.

image::document-browser.png[]

This screen contains a list of documents and supports the following operations.

Click the *Upload* button to select files to upload to the system. The *Download* button enables to download of the latest or preceding document versions.

Click the *Manage versions* button to open the <<web-dav-document-versions,WebDAV Document Versions>> screen.

To enable versioning for a particular document, click the *Enable Versioning* button. To disable versioning, click the *Disable Versioning* button.

[[lock-unlock]]
To remove a document, you should first lock it by clicking the *Lock* button.

image::lock-document.png[]

If other users try to save some change in this document, they will be warned about document locking.

image::lock-document-message.png[]

The default lock expiration timeout is set in the xref:properties.adoc#jmix-webdav-lock-timeout[jmix.webdav.lockTimeout] property.

=== Collections

`WebdavDocument` collection can be created via the *Create collection* button in the *Document browser* screen.

`WebdavDocument` collection is a special type of `WebdavDocument` that acts as a container for other documents.
The parent collection of `WebdavDocument` is specified in the `parent` attribute. If this attribute is not specified for a document, it is considered that the document belongs to the root (top-level) collection.

By default, documents inside a collection can have an identical name (for example, two separate documents with the name `1.txt` can be under the root collection). It is done because the basic case is not to use the collections and place all documents in the root. But if users want to maintain document URI uniqueness (like in real file systems), then xref:properties.adoc#jmix-webdav-auto-generate-unique-resource-uri[jmix.webdav.autoGenerateUniqueResourceUri] should be set to `false`. In this case, if a newly uploaded document has the URI that is already occupied by another document, the unique constraint violation occurs.

Click the *Rename* button to rename a collection. To remove a collection, click the *Remove* button.

== Version Control

[[web-dav-document-versions]]
=== WebDAV Document Versions

The *WebDAV Document Versions* screen provides some functionality for maintaining document versions. This functionality is supported only if versioning is enabled for a document.

There are two ways to open the *WebDAV Document Versions* screen:

. Via the xref:webdav:ui-components.adoc#webdav-document-upload-field[WebdavDocumentUploadField] component by clicking a link with a document version number.
+
image::link-for-open-versions.png[]
. Via the *Manage versions* button in the <<web-dav-document-browser,WebDAV Document Browser>> screen.

After that, the *WebDAV Document Versions* dialog window is opened.

image::web-dav-document-versions.png[]

*WebDAV Document Versions* supports the following operations:

. *Creating a new document version*. Clicking *Upload* allows selecting files to upload to the system. This can also be done by dragging and dropping a required file to the DropZone. After that, uploaded files are numbered in accordance with the number of the latest document version. Numbers of new versions are tagged with the * symbol. This means that they have been uploaded but are not linked to a document yet. Thus, version numbers can be updated after saving the changes. If the dialog window is closed without saving, then all versions tagged with * will be removed after launching <<webdav-document-versions-cleaning-job,WebdavDocumentVersionsCleaningJob>>.
+
image::drop-files-into-document-versions.png[]

. *Creating a new document version based on another one*. Selecting a document version and clicking the *Copy to head* button enables copying and numerating it in accordance with the number of the latest document version. Numbers of new versions are tagged with the * symbol. This means that they have been uploaded but are not linked to a document yet. Thus, version numbers can be updated after saving the changes. If the dialog window is closed without saving, then all versions tagged with * will be removed after launching <<webdav-document-versions-cleaning-job,WebdavDocumentVersionsCleaningJob>>.
+
image::copy-to-head.png[]

. *Opening a document for editing*. Selecting a document version and clicking the *Open* button enables opening a document for editing. Every time a document is saved in an external application, its new version is sent to the database. Use the *Refresh* button to update the list of document versions shown in *WebDAV Document Versions*.
+
[IMPORTANT]
====
Clicking *Refresh* deletes all unsaved document versions. Thus, if some document version was copied and not saved, then the changes are discarded.
====

. *Opening a document for reading (read-only)*. To open a document for reading, click a link with a file name.

. *Downloading a ZIP archive with one or several document versions*. The *Download* button contains two options for downloading selected documents/versions. The first option allows downloading documents as separate files. The *Download as ZIP* option enables sending all selected documents to the ZIP archive and downloading it. For the sake of convenience, file names contain `-v` suffixes with corresponding version numbers, for example, `example-v3.docx`, `document-v1.docx`.

=== Conflict Resolution Policies

There are several policies intended to resolve conflicts, which may occur when collaborating editing a document. By default, `RejectMergePolicy` is applied.

Let us consider an example of how these policies can be helpful. For instance, two users simultaneously opened the same document in *WebDAV Document Versions* and added a bunch of new versions. The first user finished working with their versions and saved the changes. After that, the second user did the same. Thus, the database contains versions created by both the first and second user. However, each user can see only their versions in *WebDAV Document Versions*.

This situation may cause issues with ordering and saving these conflicting document versions. To resolve the conflicts, you can use the policies mentioned below.

==== RebaseMergePolicy

`RebaseMergePolicy` allows putting new versions of a document after the ones, which already exist in the database. New versions are numbered in accordance with the number of the latest document version existing in the database.

==== CancelMyMergePolicy

If document versions have changed when working in *WebDAV Document Versions*, then all non-persistent versions (marked with * ) are deleted.

==== CancelTheirMergePolicy

If document versions have changed when working in *WebDAV Document Versions*, all versions marked with * are saved instead of those added in *WebDAV Document Versions*.

==== RejectMergePolicy

If a conflict occurs, the corresponding warning is displayed, and all new versions are not saved.

=== Overriding Default Conflict Resolution Policy

To override the default conflict resolution policy, declare a bean of the `DefaultMergePolicy` type in the main application class. The bean should return the needed merge policy. For example:

[source,java,indent=0]
----
@Bean
public DefaultMergePolicy defaultMergePolicy() {
    return RebaseMergePolicy::new;
}
----

== Scheduled Tasks

To use Quartz Job Scheduler for periodic processing of the WebDAV documents, include Quartz in your project as described in the xref:ROOT:quartz-setup.adoc[] section.

[[expired-lock-cleaning-job]]
=== ExpiredLockCleaningJob

Removes expired <<lock-unlock,lock>> objects. This job should be run every two hours by default.

To change scheduling, use the xref:webdav:properties.adoc#jmix-webdav-expired-lock-cleaning-cron[jmix.webdav.expiredLockCleaningCron] property.

[[webdav-document-versions-cleaning-job]]
=== WebdavDocumentVersionsCleaningJob

Removes `WebdavDocumentVersion` instances, which do not have links to documents. This job should be run every one month by default.

To change scheduling, use the xref:webdav:properties.adoc#jmix-webdav-document-versions-cleaning-cron[jmix.webdav.documentVersionsCleaningCron] property.

== Security

Document access restrictions are configured with xref:security:resource-roles.adoc[Resource] and xref:security:row-level-roles.adoc[Row-level] roles.

=== WebDAV Predefined Roles

Jmix application with the WebDAV add-on has two built-in resource roles:

* *WebDAV: minimal access* - basic WebDAV role which grants access for all WebDAV-related entities.
* *WebDAV: view document browser* - grants access to WebDAV documents browser.

=== Usage of Row-level Role to Restrict Access to WebdavDocument

The following example shows how to restrict access to a particular group of users. Let us consider that there is a xref:security:row-level-roles.adoc[row-level role] called `Users`. It is required to configure this role-level group so that only document authors can edit documents/document versions.

. Create a row-level role at runtime using UI screens available at *Administration → Row-level roles.*
. Create a row-level xref:security:row-level-roles.adoc#predicate-policy[predicate policy] for the `UPDATE` action and `WebdavDocument` entity.
. Define a Groovy script for the created policy:
+
[source,groovy,indent=0]
----
import io.jmix.core.security.CurrentAuthentication

def authBean = applicationContext.getBean(CurrentAuthentication)

return {E}.createdBy.equals(authBean.user.username)
----

The system checks whether the current user is a document author. If it is not the case, the user will not be allowed to edit a document, and the `Access denied` notification message will be displayed.

The *OK* button intended to save document versions will be inactive. The document itself will be opened in read-only mode.

[[digest-authentication]]
== Using Digest Authentication

Digest authentication can be enabled by setting the property:

[source,properties,indent=0]
----
jmix.webdav.authenticationMethod = digest
----

[NOTE]
====
If some application users are created in the system before activating the WebDAV add-on (for example, `admin`), the add-on functionalities are not available to them. To grant these users access, you should change their passwords.
====
