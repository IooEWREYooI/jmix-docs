= 配置

[[adding-widgets]]
== 添加小部件

默认情况下，该扩展组件没有预定义的小部件。按照下列步骤创建小部件：

1. 使用 Studio 创建一个新 xref:ui:using-fragments.adoc[fragment]。在 xref:studio:tool-window.adoc#creating-new-elements[Jmix 工具窗口中]，点击 *New -> Screen*，然后选择 *Screen Fragment* 模板。设置界面描述和控制器的名称。
2. 在界面控制器中，添加 `@DashboardWidget` 注解。
+
* 填写 `name` 参数。名称将在 xref:dashboards:user-interface.adoc#dashboard-editor[仪表盘编辑器] 展示。
* 如需使用 xref:dashboards:config.adoc#custom-widget-editor[自定义小部件编辑器]，填写 `editFragmentId`，编辑小部件时的 fragment id。

下面是一个展示公司 logo 的简单小部件：

.LogoWidget.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/dashboards/ex1/screen/widgets/LogoWidget.java[tags=logo-widget]
----

.logo-widget.xml
[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/dashboards/ex1/screen/widgets/logo-widget.xml[tags=logo-widget]
----

[[updatable-widget]]
=== 小部件更新

`RefreshableWidget` 接口支持对一个小部件进行不定时刷新。如果小部件实现了 `RefreshableWidget` 接口，在每次仪表盘更新事件触发时，都会调用其 `refresh()` 方法。

下面示例中，小部件展示一个随机的小笑话。刷新频率在创建仪表盘时，使用 xref:dashboards:user-interface.adoc#info-panel[仪表盘编辑器] 设置。

.RandomJokeWidget.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/dashboards/ex1/screen/widgets/RandomJokeWidget.java[tags=joke-widget]
----

=== 小部件参数

如果希望类成员变量作为小部件参数使用，需要为其添加 `@WindowParam` 和 `@WidgetParam` 注解。

扩展插件提供 xref:dashboards:user-interface.adoc#widget-parameter[参数编辑器] 对话框，支持创建参数并传递给小部件。

我们看看如何在代码中访问参数。下面的小部件展示一个图片，图片保存在一个类成员变量中：

.ArtWidget.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/dashboards/ex1/screen/widgets/ArtWidget.java[tags=widget]
----
<1> 包含实体 `name` 字段的常量。没有为小部件设置参数时，默认使用该值。
<2> 注入实体实例数据容器，容器中包含一个带有图片属性的实体。
<3> `Pet` 类型的类成员变量。其名称需要与参数编辑器中的 `alias` 字段相同。
<4> 注入小部件本身，为其设置新标题。
<5> 如果参数未设置，则使用 `name` 等于常量的实体。
<6> 将实体放入实例容器中。
<7> 设置小部件的标题。

小部件的界面描述可以是这样：

.art-widget.xml
[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/dashboards/ex1/screen/widgets/art-widget.xml[tags=widget]
----

== 自定义小部件编辑器

可以根据需要自定义 xref:dashboards:user-interface.adoc#widget-editor[小部件编辑器] 对话框。

下面的示例中，为自定义小部件编辑器添加一个 `EntityPicker` 组件。组件中选择的实体将作为参数在小部件中使用。

首先，使用 Studio 创建一个空的界面 xref:ui:using-fragments.adoc[fragment]：在 xref:studio:tool-window.adoc#creating-new-elements[Jmix 工具窗口]，点击 *New -> Screen* 然后选择 *Screen Fragment* 模板。设置界面描述和控制器的名称。

界面描述如下：

.pokemon-widget-editor.xml
[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/dashboards/ex1/screen/widgets/pokemon-widget-editor.xml[tags=custom-editor]
----

编辑器的控制器如下：

.PokemonWidgetEditor.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/dashboards/ex1/screen/widgets/PokemonWidgetEditor.java[tags=custom-editor]
----
<1> 定义作为小部件参数的字段。Defines a field that is used as a widget parameter.
<2> 订阅 `ValueChangeEvent`。
<3> 将选择的值设置为小部件参数。

然后，需要在小部件中定义自定义编辑器。

.PokemonWidget.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/dashboards/ex1/screen/widgets/PokemonWidget.java[tags=with-custom-editor]
----
<1> 自定义小部件编辑器的 id 在 `@DashboardWidget` 注解定义。
<2> 小部件参数从编辑器传入。

创建的编辑器界面如下：

image::widget-custom.png[align="center"]

[[predefined-roles]]
== 预定义角色

该扩展组件提供下列预定义角色：

* `dashboards-admin` - 允许用户创建和编辑仪表盘和小部件模板。
* `dashboards-view` - 允许用户查看嵌入的仪表盘。
* `dashboards-browse` - 允许用户查看可用的仪表盘列表。
