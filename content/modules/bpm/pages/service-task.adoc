= Сервисная задача

Движок Flowable предоставляет следующие способы объявить, как логика Java должна вызываться для сервисной задачи:

* Указание класса, который реализует `JavaDelegate` или `ActivityBehavior`.
* Анализ выражения, которое разрешается в объект делегирования.
* Вызов выражения метода.

Подробнее см. в https://flowable.com/open-source/docs/bpmn/ch07b-BPMN-Constructs/#java-service-task[документации Flowable^].

[[spring-bean-service-task]]
== Сервисная задача Spring Bean

Дополнение BPM добавляет еще один способ определения сервисной задачи. Он позволяет выбрать бин Spring, метод бина и указать значения параметров для выбранного метода. Имя бина и методы выбираются в выпадающих списках. После выбора метода отображается панель для ввода значений аргументов метода.

image::service-tasks/spring-bean.png[align="center"]

Панель для бинов Spring поможет построить выражение для вызова метода. В случае метода со скриншота выражение будет таким:

`${smpl_OrderStatusBean.setStatus(order, 'Sent')}`

Обратите внимание на флажок *is var*. В основном он применяется для строковых параметров. Если флажок не установлен, то значение аргумента будет записано в результирующее выражение в апострофах. Если флажок установлен, апострофы добавляться не будут, и в метод будет передана переменная с заданным именем.

* `${smpl_MyBean.someMethod('description')}` – это выражение будет использовать строковое значение `description`.
* `${smpl_MyBean.someMethod(description)}` –  это выражение будет использовать значение переменной с именем `description`.

[[java-delegate-service-task]]
== Сервисная задача делегата Java

Если выбрать `JavaDelegate class` в выпадающем списке *Type*, то появится список классов, реализующих интерфейс `org.flowable.engine.delegate.JavaDelegate`. См. https://flowable.com/open-source/docs/bpmn/ch07b-BPMN-Constructs/#implementation[документацию Flowable^] для более подробной информации.

Если выбранный класс JavaDelegate содержит поля типа `org.flowable.common.engine.api.delegate.Expression` (см. https://flowable.com/open-source/docs/bpmn/ch07b-BPMN-Constructs/#field-injection[Field Injection^] в документации Flowable), то имена полей появятся в таблице *Fields*.

Если вы хотите использовать контекст Spring в реализации `JavaDelegate`, добавьте аннотацию `@Component` и выберите `Delegate expression` в средстве моделирования.

Если вы используете инжектирование поля Flowable в `JavaDelegate` с контекстом Spring, то область действия бина должна быть установлена в `prototype` — добавьте аннотацию `@Scope(BeanDefinition.SCOPE_PROTOTYPE)`. Подробнее см. в https://flowable.com/open-source/docs/bpmn/ch07b-BPMN-Constructs/#field-injection-and-thread-safety[документации Flowable^].

Вот пример класса Java, который отправляет электронное письмо:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/service/SendEmailJavaDelegate.java[tags=java-delegate]
----
<1> Мы объявляем три поля. Значения полей определены в модели процесса.
<2> Метод `execute` вызывается, когда процесс достигает сервисной задачи.
<3> Анализ значения выражения.
<4> Создание объекта `EmailInfo`.
<5> Асинхронная отправка xref:email:index.adoc[письма].

Панель свойств сервисной задачи выглядит так:

image::service-tasks/java-delegate-panel.png[align="center"]

Указать поля можно в редакторе:

image::service-tasks/editor.png[align="center"]

В приведенном выше примере мы выбрали для поля `addressee` тип `expression`. В нашем случае переменная процесса `manager` содержит пользователя.
