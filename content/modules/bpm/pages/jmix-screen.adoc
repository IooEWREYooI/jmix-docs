= Экран Jmix

Если вам нужна процессная форма со сложной компоновкой и поведением, вы можете использовать существующий экран UI Jmix вместо диалоговых форм ввода. Контроллер экрана должен быть помечен аннотацией `@ProcessForm`, чтобы использоваться в качестве процессной формы.

Аннотация `@ProcessForm` указывает, что экран должен появиться в поле со списком процессных форм моделера.

[[process-variables]]
== Переменные процесса

Аннотацией `@ProcessVariable` можно помечать инжектированные компоненты UI или обычные поля класса.

Она указывает, что значение переменной процесса будет записано в это поле при открытии процессной формы. В случае компонента UI значением переменной процесса будет компонент UI.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm1.java[tags=variables]
----

Если настроить <<process-form-context,ProcessFormContext>> с помощью метода `saveInjectedProcessVariables()`, то значения аннотированных полей будут сохранены как переменные процесса при запуске процесса или завершении пользовательской задачи.

Аннотация `@ProcessVariable` имеет необязательный атрибут `name`. Значением этого атрибута является имя переменной процесса. Если атрибут `name` отсутствует, то в качестве имени переменной процесса используется имя поля.

[[process-form-context]]
== ProcessFormContext

Объект `ProcessFormContext` содержит информацию об определении запускаемого процесса (когда для запуска процесса используется форма) или пользовательской задачи, которую необходимо выполнить.

`ProcessFormContext` можно использовать, если процессная форма открыта из экранов *Start process* и *My tasks*. Если вам нужно открыть процессную форму с инжектированным `ProcessFormContext` программно, используйте бин <<opening-forms-programmatically,ProcessFormScreens>>.

Объект `ProcessFormContext` также содержит методы для запуска процесса и завершения задачи.

[[start-form-example]]
Пример запуска процесса:

.StartProcessForm.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm1.java[tags=start-process]
----
<1> Создание экземпляра `ProcessStarting`.
<2> Установка бизнес-ключа для экземпляра процесса.
<3> Добавление переменной процесса.
<4> Запуск процесса.
<5> Закрытие открытого окна.


[[task-form-example]]
Пример завершения пользовательской задачи:

.TaskApprovalForm.java
[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/TaskApprovalForm1.java[tags=complete-task1;complete-task2]
----

<1> Создание экземпляра `TaskCompletion`.
<2> Установка выхода задачи.
<3> Указывает, что значения полей класса, аннотированные символом, `@ProcessVariables`, должны быть собраны и сохранены как переменные процесса.
<4> Завершение задачи.
<5>	Закрытие открытого окна.

[[declare-task-outcomes]]
== Объявление выходов задачи

В моделере можно определить условие для элемента потока, выбрав пользовательскую задачу и ее выход из выпадающего списка. Чтобы заполнить этот список для пользовательской задачи, которая использует процессную форму экрана Jmix, вы можете объявить список возможных выходов в контроллере формы. Используйте для этого атрибут `outcomes` аннотации  `@ProcessForm`.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/TaskApprovalForm.java[tags=outcomes]
----

[[process-form-parameters]]
== Параметры процессных форм

Процессные формы экранов Jmix могут принимать внешние параметры, определенные в моделере. Параметры, используемые формой, определяются в атрибуте `params` аннотации `@ProcessForm`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/ActorSelectionForm.java[tags=params]
----

Эти параметры считываются моделером, и их можно увидеть после выбора экрана.

image::forms/form-params.png[align="center"]

Вы можете редактировать параметры и указать прямое значение параметра или использовать в качестве значения одну из существующих переменных процесса.

image::forms/form-params-edit.png[align="center"]

Внутри контроллера процессной формы используйте аннотацию `@ProcessFormParam` на полях класса, чтобы получить значения параметров.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/ActorSelectionForm.java[tags=params-annotation]
----

Полный список параметров процессной формы также можно получить из объекта `ProcessFormContext`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/ActorSelectionForm.java[tags=param-list]
----

Как и аннотация `@ProcessVariable`, `@ProcessFormParam` поддерживает необязательный атрибут `name`. Если атрибут не определен, то в качестве имени параметра используется имя поля.

См. <<process-form-with-parameters,пример>> процессной формы с параметрами.

[[output-variables]]
== Выходные переменные

При моделировании процесса может быть полезно знать, какие переменные задаются процессной формой экрана Jmix, чтобы позже использовать их повторно в модели процесса. Для этого используйте атрибут `outputVariabes` аннотации `@ProcessForm`.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm3.java[tags=output-variables]
----

Часто бывают случаи, когда переменная процесса устанавливается только тогда, когда задача выполнена с использованием определенного выхода. Для объявления этого поместите атрибут аннотации `outputVariables` в аннотацию `@Outcome`.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/TaskApprovalForm2.java[tags=output-variables]
----

<1> Переменная `nextActor` может быть установлена, когда задача завершена с выходом `approve`.
<2> Переменная `rejectionReason` может быть установлена, когда задача завершена с выходом `reject`.
<3> Переменная `comment` может быть установлена в любом случае.

Информация о выходных переменных отображается в соответствующем разделе панели свойств при выборе процессной формы.

image::forms/output-variables.png[align="center"]

[[restrict-process-form-usage]]
== Ограничение использования процессных форм

По умолчанию все процессные формы экранов доступны в рамках любой модели процесса. Если вы хотите использовать какой-либо экран только в определенных процессах, нужно указать ключи процессов в атрибуте `allowedProcessKeys` аннотации `@ProcessForm`.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm1.java[tags=allowed-process]
----

Форма будет доступна только для процессов с идентификаторами `process-1` и `process-2` в моделере.

[[opening-forms-programmatically]]
== Программное открытие форм

Вы можете использовать службу `ProcessFormScreens` для создания процессных форм запуска и процессных форм задач, определенных в моделере.

В приведенном ниже примере процессная форма запуска открывается нажатием кнопки на экране браузера.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/order/OrderBrowse.java[tags=start-form]
----
<1> Получение определения процесса с ключом `order-process`.
<2> Создание процессной формы запуска с полученным определением процесса.
<3> Отображение процессной формы запуска `order-process`.

Процессная форма запуска может выглядеть как в примере в разделе <<start-form-example,ProcessFormContext>>.

Для создания формы задачи используйте метод `createTaskProcessForm`:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/test/TestScreen.java[tags=task-form]
----

Процессная форма задачи может выглядеть как пример в разделе <<task-form-example,ProcessFormContext>>.

[[examples]]
== Примеры

[[start-process-form]]
=== Процессная форма запуска

Давайте рассмотрим пример процессной формы, которая используется в качестве стартовой. В форме отображаются два поля:

* текстовое поле для ввода номера заказа.
* выпадающий список пользователей для выбора менеджера. Менеджер может быть следующим актором процесса.

XML-дескриптор экрана:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/bpm/ex1/screen/forms/start-process-form.xml[tags=start-example]
----

Контроллер экрана:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm.java[tags=start-example]
----

<1> Аннотация `@ProcessForm` указывает, что этот экран является процессной формой и будет доступен в моделере.
<2> Мы объявляем, что инжектированный компонент UI `orderNumber` является переменной процесса. Поскольку мы разрабатываем процессную форму запуска, переменная еще не имеет значения, но аннотация будет использоваться при запуске процесса.
<3> То же, что и 2, но здесь имя `manager` переменной процесса отличается от имени поля `managerEntityPicker`.
<4> `ProcessFormContext` – это объект, который мы используем для запуска процесса.
<5> При запуске процесса мы можем передать необязательный бизнес-ключ экземпляра процесса. Здесь мы использовали `orderNumber`.
<6> `saveInjectedProcessVariables()` указывает, что значения полей с аннотацией `@ProcessVariables` должны быть сохранены как переменные процесса при запуске процесса.

Вместо того, что бы использовать метод `saveInjectedProcessVariables()`, вы можете задать переменные процесса явно:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/StartProcessForm2.java[tags=start-example]
----

[[task-process-form]]
=== Процессная форма задачи

Рассмотрим пример процессной формы задачи с двумя полями:

* Первый отобразит значение существующей переменной процесса – `orderNumber`.
* Второе поле будет использоваться для новой переменной процесса – `comment`.

Кнопки *Approve* и *Reject* завершают пользовательскую задачу с соответствующим выходом.

XML-дескриптор экрана:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/bpm/ex1/screen/forms/task-approval-form.xml[tags=task-example]
----

Контроллер экрана:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/TaskApprovalForm.java[tags=task-example]
----

<1> Форма определяет два возможных выхода, которые можно использовать в условии узла потока в моделере. Эта информация используется только моделером.
<2> Переменная `orderNumber` уже была установлена при запуске процесса. Из-за аннотации `@ProcessVariable` значение переменных процесса `orderNumber` будет установлено в текстовом поле `orderNumber` при отображении формы.
<3> Переменная comment еще не задана, но аннотация `@ProcessVariable` будет учтена слушателем нажатия кнопки при выполнении задачи.
<4> Значения всех полей с аннотацией `@ProcessVariable` будут сохранены как переменные процесса по завершении задачи.
<5> Альтернативный способ определения переменных процесса. Вместо того, что бы использовать метод `saveInjectedProcessVariables()`, вы можете определить переменные процесса напрямую.

[[standard-editor-process-form]]
=== Процессная форма StandardEditor

Этот пример демонстрирует, как использовать `StandardEditor` в качестве процессной формы. Это может быть полезно, если вы храните какую-либо сущность в переменной процесса и хотите просматривать или редактировать поля сущности с помощью процессной формы задачи.

Предположим, что мы добавили кнопку *Start process* в стандартный редактор сущностей `Order`. Кнопка *Start process* запускает процесс программно и помещает редактируемый экземпляр сущности `Order` в переменные процесса.

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/order/OrderEdit.java[tags=run-process]
----

<1> Размещение редактируемого объекта в переменную процесса `order`.
<2> Запускает процесс с id `order-approval`, номером заказа в качестве бизнес-ключа и мапом с переменными процесса.

Например, XML-дескриптор процессной формы для следующей пользовательской задачи может выглядеть так:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/bpm/ex1/screen/forms/order-edit-task-form.xml[tags=complete-task]
----

Единственное, что отличает XML-дескриптор формы от обычного редактора сущностей, это то, что мы заменили панель `editActions` на кнопку `Complete task`.

Контроллер экрана процессной формы:

[source,java,indent=0]
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/OrderEditTaskForm.java[tags=task-form]
----

<1> Аннотация `@ProcessForm` указывает, что экран можно использовать как процессную форму.
<2> Инжектирование переменной процесса `order`.
<3>	К моменту срабатывания слушателя `InitEvent` уже должны быть установлены значения полей `@ProcessVariable`. Мы вызываем метод `setEntityToEdit()` класса `StandardEditor` – этот метод перезагружает сущность order с представлением, необходимым для экрана редактора, и задает сущность контейнеру данных.
<4>	При нажатии кнопку *Complete task* происходит коммит редактора и выполняется завершение задачи.

[[process-form-with-parameters]]
=== Процессная форма с параметрами

Предположим, вам нужна форма для выбора следующего актора процесса. Форма должна отображать поле `EntityPicker` с пользователями и сохранять результат в переменной процесса. Мы хотим использовать форму для выбора разных акторов на разных этапах процесса, поэтому форма должна иметь два параметра:

* `variableName`
* `entityPickerCaption`

XML-дескриптор экрана:

[source,xml,indent=0]
----
include::example$/ex1/src/main/resources/bpm/ex1/screen/forms/actor-selection-form.xml[tags=actor-form]
----

Контроллер экрана:

[source,java,indent=0]s
----
include::example$/ex1/src/main/java/bpm/ex1/screen/forms/ActorSelectionForm.java[tags=actor-form1;actor-form2]
----