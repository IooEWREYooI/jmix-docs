= 最近更新

本章节包含 Jmix 框架和 Studio {page-component-display-version} 的新功能介绍，以及在升级框架版本时需要注意的一些破坏性改动。

[[upgrade]]
== 如何升级

IMPORTANT: 如需新建 Jmix {page-component-display-version} 项目或者升级已有项目，需要使用 Studio {page-component-display-version} 以上版本。因此，先 xref:studio:update.adoc[升级] Jmix Studio 插件。

参阅 xref:studio:project.adoc#upgrading-project[升级项目] 部分的介绍了解如何使用 Studio 升级项目。自动升级迁移过程会对项目做如下修改：

* 升级 Jmix BOM 的版本，BOM 又定义了所有依赖的版本。
* 升级 Jmix Gradle 插件的版本。
* 升级 Gradle wrapper 的版本至 7.5.1，修改 `gradle/wrapper/gradle-wrapper.properties` 文件。

[[new-features]]
== 新功能和改进

[[flow-ui]]
=== Flow UI

基于 Vaadin 23 的新 Flow UI 模块现在可以用来做为新建项目的坚实基础。其 API 已经足够稳定，并在后续的开发计划中按照标准规则进一步升级：提供向后兼容的补丁、主发布版本中可能引入小的不兼容等。

如需在新项目使用 Flow UI，请选择 `Full-Stack Application with Incubating FlowUI` 项目模板。

NOTE: 我们认为 Flow UI 模块现在仍处于孵化阶段，因为其功能与经典 UI 还有一定差距。

Flow UI 项目已经有少数可以使用的扩展组件：数据工具、审计，以及那些不带 UI 的扩展组件，例如 REST 或文件存储的实现。

Studio 为展示 Flow UI 提供了新的可视化设计器。与经典 UI 的设计器有很大区别，不再有 *Palette* 工具窗口。而是通过顶部的操作面板的 *Add Component*、*Component Hierarchy* 的右键菜单以及 *Generate* 菜单（*Alt+Ins / Cmd+N*）提供。

如果设计器的预览窗口显示不出来，点击顶部面板的 *Restart* 按钮。*Console* 按钮可以打开或关闭前端构建的输出控制台，可用于诊断问题。

image::flowui-designer-1.png[align="center", width="790"]

[[jtw]]
=== Jmix 工具窗口

Jmix 工具窗口的 *Configuration* 部分现在能展示所有带 `@Configuration` 注解及其派生注解（例如，`@SpringBootApplication`）的类、`@ConfigurationProperties` 类，还有 REST xref:rest:entities-api/load-entities.adoc#jpql-query-config[查询语句] 和 xref:rest:business-logic.adoc#exposing-a-service[服务] 的配置文件：

image::config-section.png[align="center", width="370"]

在实体的 *Beans* 部分展示其关联的 Spring beans，只要这些 beans 中的方法参数或者返回值是相应实体即可。

image::data-model-beans.png[align="center", width="899"]

TIP: 可以按包对展示的内容进行分组，选择 *Show Options Menu*（image:gear.svg[]） -> *Group by Packages*。

[[constructor-injection]]
=== 构造函数注入

Studio 现在支持以在 Spring beans 中使用构造函数注入的方式。在 *Choose Objects to Inject* 对话框中，选中 *Use constructor injection* 复选框：

image::constructor-injection-1.png[align="center", width="856"]

Studio 会创建一个 final 字段以及构造函数参数：

[source,java,indent=0]
----
@Component
public class CustomerService {

    private final DataManager dataManager;

    public CustomerService(DataManager dataManager) {
        this.dataManager = dataManager;
    }
}
----

Studio 会记住你的选择，可以在 Jmix 插件的配置中修改。

[[row-level-role-wizard]]
=== 行级角色向导

现在可以通过向导创建 xref:security:row-level-roles.adoc[行级角色] 和策略。

在 Jmix 工具窗口点击 *New* -> *Row-level Role*，然后在弹窗内输入角色参数：

image::rl-role-1.png[align="center", width="635"]

Studio 会创建一个带注解的角色接口。可以使用 *Add Policy* 操作添加策略：

image::rl-role-2.png[align="center", width="741"]

[[custom-project-templates]]
=== 自定义项目模板

Studio 现在支持包含项目模板的自定义制件，因此，可以提供自定义的模板用于新建项目、UI 界面以及 Flow UI 视图。

需要设置制件的坐标，点击 *Settings* -> *Jmix Plugin Settings* 然后在 *Additional templates artifact* 字段输入分组和制件名。制件的版本必须与制件模板中使用的 Jmix BOM 版本一致。

Studio 会从新建项目向导中选择的仓库中查找标准的模板制件（`io.jmix.templates.studio:jmix-studio-templates`）和自定义制件。如果都找到了，则会将模板合并，且自定义模板的优先级更高。也支持覆盖标准模板，只需要在同一个目录下提供自定义的模板，例如 `content/project/application`。

按照下面的步骤可以构建一个包含自定义模板的制件。

. 克隆 https://github.com/jmix-framework/jmix 仓库，将 `jmix-templates` 子目录复制到点到的其他文件夹。

. 修改 `build.gradle` 文件的 `group` 属性，示例：
+
[source,groovy]
----
group = 'com.company.templates'
----

. 修改 `gradle.properties` 里面的 `version` 为需要的 Jmix BOM 版本，示例：
+
[source,properties]
----
version = 1.4.0
----

. 修改已有的模板或添加自己的模板。例如，将 `content/project/application` 复制为 `my-application` 并修改 `template.json` 文件的 `name` 和 `order` 设置：
+
[source,json]
----
{
  "version": 1,
  "name": "My Full-Stack Application",
  "order": 50,
  "addon": false,
  ...
}
----

. 构建并发布至本地 Maven 仓库：
+
[source,shell]
----
./gradlew publishToMavenLocal
----

. 点击 *Settings* -> *Jmix Plugin Settings* 然后在 *Additional templates artifact* 字段输入 `com.company.templates:jmix-studio-templates`。

. 从 IDE 系统文件夹删除模板缓存：
* 按照 https://www.jetbrains.com/help/idea/directories-used-by-the-ide-to-store-settings-caches-plugins-and-logs.html#system-directory[IntelliJ IDEA 文档^] 的说明找到 IDE 的缓存文件夹。
* 删除 `jmix/templates` 子目录内的所有内容。

. 新建一个项目，选中 *Use local Maven repository* 复选框。在 *Jmix version* 下拉框，选择自定义制件的版本。

. 在向导的下一步，可以看到模板列表中包含了自定义的模板。

[[security-configuration-extension-points]]
=== 安全配置扩展点

现在可以对框架和扩展组件提供的安全配置进行扩展，而不像之前，只能完全替换。

如需调整安全配置，定义一个继承 `AbstractHttpConfigurer` 的 Spring bean，使用合适的 `@Qualifier` 注解。

扩展 `StandardSecurityConfiguration` 的示例：

[source,java]
----
@Component
@Qualifier(StandardSecurityConfiguration.SECURITY_CONFIGURER_QUALIFIER)
public class MySecurityConfigurer extends AbstractHttpConfigurer<MySecurityConfigurer, HttpSecurity> {

    @Override
    public void configure(HttpSecurity http) throws Exception {
        MyFilter myFilter = new MyFilter();
        http.addFilterBefore(myFilter, UsernamePasswordAuthenticationFilter.class);
    }
}
----

扩展 OIDC 组件中安全配置的示例：

[source,java]
----
@Component
@Qualifier(OidcAutoConfiguration.OAuth2LoginSecurityConfiguration.SECURITY_CONFIGURER_QUALIFIER)
public class MyOidcSecurityConfigurer extends AbstractHttpConfigurer<MyOidcSecurityConfigurer, HttpSecurity> {
    @Override
    public void init(HttpSecurity http) throws Exception {
	// any method that adds another configurer must be invoked in the init method
        http.headers(headers -> {
            headers.frameOptions().deny();
        });
    }
}
----

[[custom-password-validation]]
=== 自定义密码验证

如需实现应用程序中的自定义密码验证逻辑，可以创建一个 bean（或多个 bean）实现 `PasswordValidator` 接口，示例：

[source,java]
----
@Component
public class MyPasswordValidator implements PasswordValidator<User> {

    @Override
    public void validate(PasswordValidationContext<User> context) throws PasswordValidationException {
         if (context.getPassword().length() < 3)
            throw new PasswordValidationException("Password is too short, must be >= 3 characters");
    }
}
----

所有的密码验证器都会自动用在 `ChangePassword` 操作对话框中。

如需在用户编辑或详情界面添加验证器，使用 `PasswordValidation` 助手类：

[source,java]
----
@Autowired
private PasswordValidation passwordValidation;

@Subscribe
protected void onBeforeCommit(BeforeCommitChangesEvent event) {
  if (entityStates.isNew(getEditedEntity())) {
      // ...
      List<String> validationErrors = passwordValidation.validate(getEditedEntity(), passwordField.getValue());
      if (!validationErrors.isEmpty()) {
          notifications.create(Notifications.NotificationType.WARNING)
                  .withCaption(String.join("\n", validationErrors))
                  .show();
          event.preventCommit();
      }
      getEditedEntity().setPassword(passwordEncoder.encode(passwordField.getValue()));
  }
}
----

[[pessimistic-lock-by-datamanager]]
=== DataManager 使用悲观锁

`DataManager` 流式加载接口现在可以在 `lockMode()` 方法使用 `javax.persistence.LockModeType` 枚举值。当处理 JPA 实体时，会在数据库级别使用 `select ... for update` 语句形成相应的悲观锁。

示例：

[source,java]
----
dataManager.load(Customer)
        .id(customerId)
        .lockMode(LockModeType.PESSIMISTIC_WRITE)
        .one()
----

[[preview]]
== 功能预览

[[authorization-server]]
=== 认证服务

Jmix 认证服务扩展组件提供分发 access 和 refresh token，并使用这些 token 保护 API 资源（REST API，自定义控制器）的功能。支持为客户端和移动端授予认证码，以及为服务端的端到端交互授予秘钥。

该扩展组件基于 https://spring.io/projects/spring-authorization-server[Spring Authorization Server^] 构建。Jmix 认证服务是 Jmix 安全机制 OAuth2 模块的升级版，OAuth2 模块依赖的 Spring Security OAuth 项目已经过时。

查看项目的 https://github.com/jmix-framework/jmix/blob/master/jmix-authorization-server/README.md[README 文档^] 了解更多内容。

[[breaking-changes]]
== 破坏性改动

[[migration-to-securityfilterchain]]
=== 迁移至 SecurityFilterChain

框架的安全配置部分已经从废弃的 `WebSecurityConfigurerAdapter` 迁移至 `SecurityFilterChain`。

如果项目有扩展 `WebSecurityConfigurerAdapter` 的安全配置，请按照 Spring 博客的 https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter[这篇文章^] 的建议重写。

[[user-reloading-in-currentauthentication]]
=== CurrentAuthentication 中重加载用户

为了修复 https://github.com/jmix-framework/jmix/issues/948[当前用户属性加载的问题^]，同时避免出现其他的不一致性，`CurrentAuthentication.getUser()` 和 `CurrentUserSubstitution.getEffectiveUser()` 方法会在每次调用时重新加载 user 实体。

如果要避免由于此改动造成的性能影响，可以配置 user 实体的缓存，示例：
[source,properties]
----
eclipselink.cache.shared.User = true
eclipselink.cache.size.User = 500
----

新建项目会自动配置这个缓存。

如果新的加载行为引起了其他的问题，可以设置 `jmix.core.current-authentication-user-reload-enabled` 为 `false` 关闭。

[[changelog]]
== 变更日志

* Jmix 框架修复的问题：

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+project%3Ajmix-framework%2Fjmix%2F4[1.4.0^]

* Jmix Studio 修复的问题：

** https://youtrack.jmix.io/issues/JST?q=Fixed%20in%20builds:%201.4.0,-1.3.*[1.4.0^]
