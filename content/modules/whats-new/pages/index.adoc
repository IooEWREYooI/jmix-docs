= Что нового

В данном разделе приведена информация о новой функциональности и возможных несовместимых изменениях в фреймворке Jmix и Jmix Studio версии {page-component-display-version}. Примите их во внимание при обновлении с предыдущей версии фреймворка.

[IMPORTANT]
====
Для создания новых проектов в Jmix {page-component-display-version} или для апгрейда существующего проекта требуется Studio {page-component-display-version} или более поздней версии, поэтому в первую очередь xref:studio:update.adoc[обновите] плагин Jmix Studio.

Минимальная требуемая версия IntelliJ IDEA - 2022.1.
====

Перейдите к разделу xref:studio:project.adoc#upgrading-project[Апгрейд проекта], чтобы узнать, как обновить проект с помощью Studio. Процедура автоматической миграции вносит следующие изменения в ваш проект:

* Обновляет версию Jmix BOM, которая, в свою очередь, определяет версии всех зависимостей.
* Обновляет версию Jmix Gradle plugin.
* Обновляет версию Gradle wrapper до 7.5.1 в `gradle/wrapper/gradle-wrapper.properties`.

[[new-features]]
== Новая и улучшенная функциональность

[[flow-ui]]
=== Flow UI

Новый модуль xref:flow-ui:index.adoc[Flow UI], основанный на Vaadin 23, теперь доступен как надежная основа для создания новых проектов. Его API достаточно стабилен и в дальнейшем будет развиваться по стандартным правилам: обратно-совместимые патчи, возможные незначительные несовместимости в минорных функциональных релизах.

Для использования Flow UI в новом проекте, создайте проект с помощью шаблона `Full-Stack Application with Incubating FlowUI`.

NOTE: Мы рассматриваем Flow UI как модуль, находящийся "в развитии" (incubating), так как пока он несопоставим по функциональности с классическим UI.

Для использования в проектах с Flow UI доступны некоторые дополнения: Data Tools, Audit, а также все дополнения без UI, такие как REST и файловые хранилища.

Studio включает в себя новый визуальный дизайнер для экранов Flow UI. У него есть существенное отличие от дизайнера классического UI: панель *Palette* отсутствует. Вместо нее используется действие *Add Component*, которое доступно из верхней панели действий, через контекстное меню панели *Component Hierarchy* и меню *Generate* (*Alt+Ins / Cmd+N*).

Если предпросмотр отображается неверно, попробуйте нажать кнопку *Restart* в верхней панели дизайнера. Кнопка *Console* открывает и закрывает консоль с выводом сборки фронтенда, что может помочь в диагностике проблем.

image::flowui-designer-1.png[align="center", width="790"]

[[jtw]]
=== Окно инструментов Jmix

Секция *Configuration* окна инструменов Jmix теперь отображает все классы, аннотированные `@Configuration` и ее производными (например `@SpringBootApplication`), классы `@ConfigurationProperties`, а также конфигурационные файлы REST xref:rest:entities-api/load-entities.adoc#jpql-query-config[queries] и xref:rest:business-logic.adoc#exposing-a-service[services]:

image::config-section.png[align="center", width="370"]

Бины Spring, имеющие методы с сущностью в аргументах или результате, отображаются в секции *Beans* данной сущности:

image::data-model-beans.png[align="center", width="899"]

TIP: Элементы дерева могут быть сгруппированы по пакетам: см. *Show Options Menu* (image:gear.svg[]) -> *Group by Packages*.

[[constructor-injection]]
=== Инжекция в конструктор

Studio поддерживает инжекцию зависимостей в конструкторы бинов Spring. Для этого установите в диалоге *Choose Objects to Inject* флажок *Use constructor injection*:

image::constructor-injection-1.png[align="center", width="856"]

Тогда Studio создаст финальное поле и аргумент конструктора:

[source,java,indent=0]
----
@Component
public class CustomerService {

    private final DataManager dataManager;

    public CustomerService(DataManager dataManager) {
        this.dataManager = dataManager;
    }
----

Ваш выбор будет запомнен. Вы сможете изменить его позже в диалоге *Choose Objects to Inject* и в окне xref:studio:plugin-settings.adoc[настроек плагина Jmix].

[[row-level-role-wizard]]
=== Мастер создания ролей уровня строк

Теперь вы можете создавать xref:security:row-level-roles.adoc[роли уровня строк] и их политики используя мастер, запускаемый командой *New* -> *Row-level Role* в панели инструментов Jmix. См. раздел xref:studio:role-designer.adoc#row-level-role-wizard[Мастер ролей уровня строк].

[[custom-project-templates]]
=== Собственные шаблоны проектов

Studio 1.4 поддерживает возможность использования собственного (кастомного) артефакта с шаблонами. С помощью такого артефакта можно предоставлять разработчику собственные шаблоны проектов и экранов UI/FlowUI.

Подробная информация приведена в разделе xref:studio:custom-project-templates.adoc[].

[[security-configuration-extension-points]]
=== Точки расширения конфигурации Security

Конфигурации security, предоставляемые фреймворком и дополнениями, теперь можно расширять, вместо того чтобы полностью заменять их.

Чтобы донастроить какую-либо конфигурацию, нужно определить бин Spring, расширяющий класс `AbstractHttpConfigurer` и аннотировать его соответствующим `@Qualifier`.

Пример донастройки `StandardSecurityConfiguration`:

[source,java]
----
@Component
@Qualifier(StandardSecurityConfiguration.SECURITY_CONFIGURER_QUALIFIER)
public class MySecurityConfigurer extends AbstractHttpConfigurer<MySecurityConfigurer, HttpSecurity> {

    @Override
    public void configure(HttpSecurity http) throws Exception {
        MyFilter myFilter = new MyFilter();
        http.addFilterBefore(myFilter, UsernamePasswordAuthenticationFilter.class);
    }
}
----

Пример расширения конфигурации security дополнения OIDC:

[source,java]
----
@Component
@Qualifier(OidcAutoConfiguration.OAuth2LoginSecurityConfiguration.SECURITY_CONFIGURER_QUALIFIER)
public class MyOidcSecurityConfigurer extends AbstractHttpConfigurer<MyOidcSecurityConfigurer, HttpSecurity> {
    @Override
    public void init(HttpSecurity http) throws Exception {
	// any method that adds another configurer must be invoked in the init method
        http.headers(headers -> {
            headers.frameOptions().deny();
        });
    }
}
----

[[custom-password-validation]]
=== Собственная валидация паролей

Чтобы реализовать собственную валидацию паролей в приложении, достаточно создать бин (или несколько бинов), реализующий интерфейс `PasswordValidator`. Например:

[source,java]
----
@Component
public class MyPasswordValidator implements PasswordValidator<User> {

    @Override
    public void validate(PasswordValidationContext<User> context) throws PasswordValidationException {
         if (context.getPassword().length() < 3)
            throw new PasswordValidationException("Password is too short, must be >= 3 characters");
    }
}
----

Все валидаторы будут автоматически использованы в диалоге действия ChangePassword.

Для добавления кастомной валидации в экран редактирования сущности User, используйте бин-помощник `PasswordValidation`:

[source,java]
----
@Autowired
private PasswordValidation passwordValidation;

@Subscribe
protected void onBeforeCommit(BeforeCommitChangesEvent event) {
  if (entityStates.isNew(getEditedEntity())) {
      // ...
      List<String> validationErrors = passwordValidation.validate(getEditedEntity(), passwordField.getValue());
      if (!validationErrors.isEmpty()) {
          notifications.create(Notifications.NotificationType.WARNING)
                  .withCaption(String.join("\n", validationErrors))
                  .show();
          event.preventCommit();
      }
      getEditedEntity().setPassword(passwordEncoder.encode(passwordField.getValue()));
  }
}
----

[[pessimistic-lock-by-datamanager]]
=== Пессимистичная блокировка в DataManager

Fluent-интерфейс загрузки сущностей `DataManager` теперь принимает значения перечисления `javax.persistence.LockModeType` в методе `lockMode()`. При работе с JPA-сущностями, это вызывает соответствующую пессимистичную блокировку на уровне базы данных с помощью оператора `select ... for update`.

Например:

[source,java]
----
Customer customer = dataManager.load(Customer.class)
        .id(customerId)
        .lockMode(LockModeType.PESSIMISTIC_WRITE)
        .one();
----

[[preview]]
== Предварительные функции

[[authorization-server]]
=== Сервер авторизации

Новое дополнение Jmix Authorization Server позволяет выпускать access и refresh токены и защищать ресурсы внешнего API (REST API, кастомные контроллеры) с помощью этих токенов. Сервер авторизации поддерживает authorization code grant для веб и мобильных клиентов и client credentials grant для межсерверного взаимодействия.

Дополнение построено на основе https://spring.io/projects/spring-authorization-server[Spring Authorization Server^]. Jmix Authorization Server является заменой модуля Jmix Security OAuth2, который зависит от устаревшего проекта Spring Security OAuth.

Более подробная информация о дополнении приведена в https://github.com/jmix-framework/jmix/blob/master/jmix-authorization-server/README.md[README^] проекта.

[[breaking-changes]]
== Опасные изменения

[[migration-to-securityfilterchain]]
=== Миграция на SecurityFilterChain

Конфигурации security фреймворка и дополнений мигрированы с устаревшего `WebSecurityConfigurerAdapter` на рекомендуемый `SecurityFilterChain`.

Если у вас есть конфигурации security, расширяющие `WebSecurityConfigurerAdapter`, перепишите их следуя рекомендациям https://spring.io/blog/2022/02/21/spring-security-without-the-websecurityconfigureradapter[данной статьи^] из блога Spring.

[[changelog]]
== Список изменений

* Решенные проблемы в Jmix Framework:

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+milestone%3A1.4.4[1.4.4^]

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+milestone%3A1.4.3[1.4.3^]

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+milestone%3A1.4.2[1.4.2^]

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+milestone%3A1.4.1[1.4.1^]

** https://github.com/jmix-framework/jmix/issues?q=is%3Aclosed+milestone%3A1.4.0[1.4.0^]

* Решенные проблемы в Jmix Studio:

** https://youtrack.jmix.io/issues/JST?q=Fixed%20in%20builds:%201.4.3[1.4.3^]
** https://youtrack.jmix.io/issues/JST?q=Fixed%20in%20builds:%201.4.2[1.4.2^]
** https://youtrack.jmix.io/issues/JST?q=Fixed%20in%20builds:%201.4.1[1.4.1^]
** https://youtrack.jmix.io/issues/JST?q=Fixed%20in%20builds:%201.4.0,-1.3.*[1.4.0^]
